# ä¸‰æ©™æ™ºæ˜Ÿå¼€å‘å›¢é˜ŸæŠ€æœ¯åè®®ä¸å¼€å‘è§„èŒƒ V1.2

## æ–‡æ¡£è¯´æ˜
æœ¬åè®®æ˜¯"é›†å›¢åŒ–æ•™è‚²ç®¡ç†ç³»ç»Ÿ"é¡¹ç›®çš„æ ¸å¿ƒæŠ€æœ¯è§„èŒƒæ–‡æ¡£ï¼Œæ‰€æœ‰è¿œç¨‹åˆä½œå¼€å‘è€…å¿…é¡»ä¸¥æ ¼éµå®ˆã€‚ä»£ç è´¨é‡ä¸è§„èŒƒæ‰§è¡Œæƒ…å†µå°†ç›´æ¥ä½œä¸ºäº¤ä»˜éªŒæ”¶å’Œç»“ç®—çš„ä¾æ®ã€‚

**ä»»ä½•ç ´åæ•°æ®è®¿é—®æƒé™ã€ç ´åå±‚çº§ä¸€è‡´æ€§ã€è¿åå®‰å…¨è§„èŒƒçš„ä»£ç å°†ä¸äºˆåˆå¹¶ä¸”è§†ä¸ºä¸åˆæ ¼äº¤ä»˜ã€‚**

---

## 1. é¡¹ç›®èƒŒæ™¯ä¸æ¶æ„æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½
æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªé¢å‘é›†å›¢åŒ–å­¦æ ¡çš„æ•™è‚²ç®¡ç†å¹³å°ï¼Œæ”¯æŒï¼š
- å¤šæ‰€å­¦æ ¡ï¼ˆåˆä¸­ã€é«˜ä¸­ã€å°å­¦ï¼‰çš„ç»Ÿä¸€ç®¡ç†
- å­¦æ ¡å¯åŒ…å«å¤šä¸ªæ ¡åŒº
- é›†å›¢å±‚é¢å¯æŸ¥çœ‹æ‰€æœ‰å­¦æ ¡çš„æ±‡æ€»æ•°æ®
- å­¦æ ¡æ•°æ®é€šè¿‡school_idè¿›è¡ŒåŒºåˆ†

### 1.2 æ¶æ„ç‰¹ç‚¹
- **å¾®æœåŠ¡æ¶æ„**ï¼šåŸºäº go-zero æ¡†æ¶
- **æ•°æ®ç»“æ„**ï¼šå…±äº«æ•°æ®åº“ï¼Œä½¿ç”¨ UUID ä½œä¸ºä¸»é”®ï¼Œé€šè¿‡school_idå…³è”å­¦æ ¡
- **å±‚çº§åŒ–ç»„ç»‡**ï¼šé›†å›¢ â†’ å­¦æ ¡ â†’ æ ¡åŒº â†’ å­¦éƒ¨ â†’ éƒ¨é—¨ â†’ ç­çº§
- **å¿«é€Ÿè¿­ä»£**ï¼šé‡‡ç”¨ Monorepo æ¨¡å¼ï¼Œæ”¯æŒæ•æ·å¼€å‘

---

## 2. æ ¸å¿ƒæŠ€æœ¯æ ˆï¼ˆè°¨æ…å˜æ›´ï¼‰

æ‰€æœ‰å¼€å‘è€…å¿…é¡»åœ¨ä»¥ä¸‹é¢„è®¾æŠ€æœ¯æ ˆå†…è¿›è¡Œå¼€å‘ï¼Œå¢åŠ ç¬¬ä¸‰æ–¹åº“éœ€é¡¹ç›®è´Ÿè´£äººè¯„å®¡ï¼Œ**ä¸¥ç¦æ“…è‡ªå¼•å…¥æœªç»è¯„å®¡çš„ç¬¬ä¸‰æ–¹åº“**ã€‚

### 2.1 åç«¯æŠ€æœ¯æ ˆ
- **è¯­è¨€**ï¼šGo 1.20+
- **æ¡†æ¶**ï¼šgo-zeroï¼ˆå¾®æœåŠ¡æ¡†æ¶ï¼‰
- **ORM**ï¼šEnt (entgo.io)
- **æ•°æ®åº“**ï¼šPostgreSQL 15ï¼ˆç¦æ­¢ä½¿ç”¨ MySQL ç‰¹æ€§ï¼‰
- **ä¸»é”®è§„èŒƒ**ï¼šä¸šåŠ¡è¡¨ä¸»é”®ä½¿ç”¨ UUID (github.com/google/uuid)ï¼Œschool_idå¼•ç”¨organizationè¡¨çš„å­¦æ ¡è®°å½•

### 2.2 ä¸­é—´ä»¶ä¸åŸºç¡€è®¾æ–½
- **ç¼“å­˜**ï¼šRedis 7+
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šKafkaï¼ˆäº‹ä»¶æµï¼‰
- **ä»»åŠ¡é˜Ÿåˆ—**ï¼šAsynqï¼ˆå»¶è¿Ÿä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ï¼‰
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šDTMï¼ˆè·¨æœåŠ¡äº‹åŠ¡ä¸€è‡´æ€§ï¼‰
- **é“¾è·¯è¿½è¸ª**ï¼šJaeger
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šELK Stack (Elasticsearch + Logstash + Kibana)
- **æ—¥å¿—æ¸…æ´—**ï¼šGo-stash

### 2.3 å‰ç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**ï¼šAnt Design Pro 6 (React)
- **è¯­è¨€**ï¼šTypeScriptï¼ˆç¦æ­¢è¿‡åº¦ä½¿ç”¨ anyï¼‰
- **ä»£ç è§„èŒƒ**ï¼šESLint + Prettier

### 2.4 å¼€å‘ä¸éƒ¨ç½²
- **å¼€å‘ç¯å¢ƒ**ï¼šDocker-compose
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šKubernetes (K8s)
- **ä»£ç ä»“åº“**ï¼šMonorepo æ¨¡å¼
- **CI/CD**ï¼šGitLab CI / GitHub Actions

---

## 3. å­¦æ ¡æ•°æ®ç®¡ç†è§„èŒƒï¼ˆæ ¸å¿ƒè§„èŒƒï¼‰

è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ç®¡ç†è§„èŒƒï¼Œè¿åä»¥ä¸‹æ¡æ¬¾è§†ä¸º**é‡å¤§äº¤ä»˜äº‹æ•…**ã€‚

### 3.1 å­¦æ ¡æ ‡è¯†å®šä¹‰

#### 3.1.1 å¼ºåˆ¶å­—æ®µ
æ‰€æœ‰ä¸šåŠ¡è¡¨ï¼ˆå­¦ç”Ÿã€æ•™å¸ˆã€è¯¾ç¨‹ã€æˆç»©ç­‰ï¼‰å¿…é¡»é€šè¿‡ **Ent Mixin** åµŒå…¥ä»¥ä¸‹å­—æ®µï¼š
- `school_id` (UUID)ï¼šæ‰€å±å­¦æ ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œå¤–é”®å…³è”organizationè¡¨
  - **ä¸šåŠ¡å«ä¹‰**ï¼šå½“å‰è®°å½•æ‰€å±çš„å­¦æ ¡
  - **è®¾è®¡è€ƒè™‘**ï¼šé€šè¿‡school_idå…³è”organizationè¡¨ï¼ˆtype='SCHOOL'ï¼‰çš„è®°å½•
- è¯¥å­—æ®µè®¾ç½®ä¸º **Immutable**ï¼ˆå†™å…¥åä¸å¯ä¿®æ”¹ï¼‰

#### 3.1.2 èº«ä»½è¯†åˆ«è§„åˆ™
**ç¦æ­¢**ä»…é€šè¿‡ `role` å­—æ®µåˆ¤å®šæƒé™ã€‚å¿…é¡»è§£æ JWT ä¸­çš„ä»¥ä¸‹ä¿¡æ¯ï¼š
- `org_id` (UUID)ï¼šç”¨æˆ·æ‰€å±ç»„ç»‡ID
- `org_type` (enum)ï¼šç»„ç»‡ç±»å‹ï¼ˆGROUP/SCHOOL/CAMPUS/DEPARTMENTï¼‰
- `role` (string)ï¼šç”¨æˆ·è§’è‰²ï¼ˆä»…ä½œä¸ºè¾…åŠ©åˆ¤æ–­ï¼‰

### 3.2 å±‚çº§ç»„ç»‡æ ‘æ¨¡å‹

#### 3.2.1 æ•°æ®æ¨¡å‹
ç»„ç»‡æ¶æ„é‡‡ç”¨ **"é‚»æ¥è¡¨ + è·¯å¾„æšä¸¾"** æ··åˆæ¨¡å¼ï¼š
- `id` (UUID)ï¼šä¸»é”®
- `parent_id` (UUID, nullable)ï¼šçˆ¶çº§ç»„ç»‡ID
- `path` (string)ï¼šå±‚çº§è·¯å¾„ï¼ˆå¦‚ï¼š`root_uuid.school_uuid.dept_uuid`ï¼‰
- `type` (enum)ï¼šç»„ç»‡ç±»å‹ï¼ˆGROUP/SCHOOL/CAMPUS/DEPARTMENT/CLASSï¼‰

#### 3.2.2 è·¯å¾„ç»´æŠ¤è§„åˆ™
- **è‡ªåŠ¨ç»´æŠ¤**ï¼šå¿…é¡»é€šè¿‡ **Ent Hook** è‡ªåŠ¨ç»´æŠ¤ `path` å­—æ®µçš„ä¸€è‡´æ€§
- **é˜²å¾ªç¯å¼•ç”¨**ï¼šåœ¨ API å±‚æ ¡éªŒï¼Œç¦æ­¢å°†ä¸€ä¸ªç»„ç»‡çš„çˆ¶çº§è®¾ç½®ä¸ºå…¶å­èŠ‚ç‚¹
- **ç´¢å¼•è¦æ±‚**ï¼šå¿…é¡»ä¸º `parent_id` å’Œ `path` å­—æ®µå»ºç«‹ç´¢å¼•

### 3.3 é›†å›¢æ•°æ®è®¿é—®è§„åˆ™

#### 3.3.1 è®¿é—®æ¨¡å¼
ç³»ç»Ÿæ”¯æŒä¸¤ç§è®¿é—®æ¨¡å¼ï¼š
1. **å­¦æ ¡æ¨¡å¼ï¼ˆSchool Modeï¼‰**ï¼šå­¦æ ¡ç”¨æˆ·ï¼Œåªèƒ½è®¿é—®æœ¬æ ¡æ•°æ®
2. **é›†å›¢æ¨¡å¼ï¼ˆGroup Modeï¼‰**ï¼šé›†å›¢ç”¨æˆ·ï¼Œå¯æŸ¥çœ‹æ±‡æ€»æ•°æ®æˆ–æŒ‡å®šå­¦æ ¡æ•°æ®

#### 3.3.2 X-View-Scope è¯·æ±‚å¤´è§„èŒƒ
é›†å›¢ç«¯å‘èµ·çš„ API è¯·æ±‚ï¼ŒHeader å¯æºå¸¦ `X-View-Scope`ï¼š
- `X-View-Scope: all`ï¼šè·å–å…¨é›†å›¢æ±‡æ€»æ•°æ®ï¼ˆéœ€é›†å›¢ç®¡ç†å‘˜èº«ä»½ï¼‰
- `X-View-Scope: {school_uuid}`ï¼šè®¿é—®ç‰¹å®šå­¦æ ¡æ•°æ®

#### 3.3.3 æƒé™æ ¡éªŒæœºåˆ¶
åç«¯æ‹¦æˆªå™¨å¿…é¡»æ ¡éªŒï¼š
- å½“å‰ç™»å½•ç”¨æˆ·çš„ç»„ç»‡èº«ä»½
- æ˜¯å¦æœ‰æƒè®¿é—® `X-View-Scope` æŒ‡å‘çš„å­¦æ ¡
- é€šè¿‡ `path` å­—æ®µéªŒè¯ç›®æ ‡å­¦æ ¡æ˜¯å¦åœ¨ç”¨æˆ·æˆæƒå­æ ‘å†…

#### 3.3.4 æ•°æ®æŸ¥è¯¢å®ç°
**å»ºè®®è§„åˆ™**ï¼š
- ä¸šåŠ¡æŸ¥è¯¢å»ºè®®åŒ…å« `school_id` è¿‡æ»¤æ¡ä»¶ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
- é›†å›¢ç®¡ç†å‘˜å¯é€šè¿‡ `X-View-Scope` æŒ‡å®šè¦æŸ¥çœ‹çš„å­¦æ ¡æ•°æ®
- Context ä¸­æ³¨å…¥å½“å‰è®¿é—®çš„ school_id ä¿¡æ¯

**æ³¨æ„**ï¼š
- ä¸å¼ºåˆ¶è¦æ±‚ä½¿ç”¨ Ent Privacy Policy è‡ªåŠ¨è¿‡æ»¤
- ä¸šåŠ¡å±‚å¯æ ¹æ®éœ€è¦æ‰‹åŠ¨æ·»åŠ  `school_id` è¿‡æ»¤æ¡ä»¶

### 3.4 æŸ¥è¯¢æ€§èƒ½è§„èŒƒ

#### 3.4.1 å»ºè®®äº‹é¡¹
- **æ¨èæ·»åŠ school_idè¿‡æ»¤**ï¼šæŸ¥è¯¢æ—¶æ·»åŠ school_idæ¡ä»¶å¯æå‡æ€§èƒ½
- **å¼ºåˆ¶åˆ†é¡µ**ï¼šåˆ—è¡¨æŸ¥è¯¢å¿…é¡»å¼ºåˆ¶åˆ†é¡µï¼Œ`limit` æœ€å¤§å€¼ä¸å¾—è¶…è¿‡ 100

#### 3.4.2 èšåˆæŸ¥è¯¢æ–¹æ¡ˆ
é’ˆå¯¹é›†å›¢å±‚é¢çš„æŠ¥è¡¨æŸ¥è¯¢ï¼ˆå¦‚ï¼šå…¨é›†å›¢æ€»äººæ•°ã€å¹³å‡åˆ†ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨ä»¥ä¸‹æ–¹æ¡ˆä¹‹ä¸€ï¼š
1. ä½¿ç”¨ PostgreSQL çš„ **Materialized Views** å®šæ—¶åˆ·æ–°
2. ä½¿ç”¨ **Kafka + Go-stash** å°†æ˜ç»†æ•°æ®å¼‚æ­¥èšåˆåˆ°ä¸“ç”¨ç»Ÿè®¡è¡¨
3. ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹èšåˆæ•°æ®

### 3.5 å®¡è®¡è¿½è¸ªï¼ˆAudit Loggingï¼‰

#### 3.5.1 å¼ºåˆ¶è®°å½•åœºæ™¯
é›†å›¢äººå‘˜"è¿›å…¥"å­¦æ ¡è§†è§’æŸ¥çœ‹æˆ–ä¿®æ”¹æ•°æ®çš„è¡Œä¸ºï¼Œå¿…é¡»é€šè¿‡ middleware è‡ªåŠ¨è®°å½•å®¡è®¡æ—¥å¿—ã€‚

#### 3.5.2 æ—¥å¿—æ ¼å¼è¦æ±‚
å®¡è®¡æ—¥å¿—å¿…é¡»åŒ…å«ï¼š
- `operator_id` (UUID)ï¼šé›†å›¢ç”¨æˆ·ID
- `operator_name` (string)ï¼šæ“ä½œäººå§“å
- `target_school_id` (UUID)ï¼šè¢«æ“ä½œå­¦æ ¡ID
- `action` (string)ï¼šæ“ä½œåŠ¨ä½œï¼ˆVIEW/CREATE/UPDATE/DELETEï¼‰
- `resource_type` (string)ï¼šèµ„æºç±»å‹ï¼ˆSTUDENT/TEACHER/GRADEï¼‰
- `resource_id` (UUID)ï¼šèµ„æºID
- `trace_id` (string)ï¼šé“¾è·¯è¿½è¸ªID
- `timestamp` (timestamp)ï¼šæ“ä½œæ—¶é—´

---

## 4. æ•°æ®åº“è®¾è®¡è§„èŒƒï¼ˆPostgreSQL 15ï¼‰

### 4.1 æ•°æ®ç±»å‹è§„èŒƒ

#### 4.1.1 UUID ç±»å‹
- æ•°æ®åº“å­—æ®µå¿…é¡»å£°æ˜ä¸º `UUID` ç±»å‹ï¼Œ**ä¸¥ç¦ä½¿ç”¨ VARCHAR(36)**
- Go ä»£ç ä¸­ä½¿ç”¨ `github.com/google/uuid` åŒ…
- ç¦æ­¢åœ¨ URL ä¸­æš´éœ²ä»»ä½•è‡ªå¢ ID

#### 4.1.2 JSONB ä½¿ç”¨é™åˆ¶
- **å…è®¸åœºæ™¯**ï¼šä»…é™å­˜å‚¨éç»“æ„åŒ–é…ç½®æ•°æ®ï¼ˆå¦‚ï¼šé¡µé¢å¸ƒå±€è®¾ç½®ã€ç”¨æˆ·åå¥½ï¼‰
- **ç¦æ­¢åœºæ™¯**ï¼šæ¶‰åŠé‡‘é¢ã€æˆç»©ã€è€ƒå‹¤ç­‰æ ¸å¿ƒä¸šåŠ¡æ•°æ®ä¸¥ç¦ä½¿ç”¨ JSONB
- **ç´¢å¼•è¦æ±‚**ï¼šå¦‚ä½¿ç”¨ JSONBï¼Œå¿…é¡»ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºç«‹ GIN ç´¢å¼•

### 4.2 ç´¢å¼•è§„èŒƒ

#### 4.2.1 å¤åˆç´¢å¼•é¡ºåº
ä¸šåŠ¡è¡¨ç´¢å¼•å»ºè®®è€ƒè™‘ **(school_id, business_field)** çš„é¡ºåºï¼š
```sql
-- å»ºè®®ç¤ºä¾‹ï¼ˆschool_idåœ¨é¦–ä½å¯æå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
CREATE INDEX idx_student_school_no ON students (school_id, student_no);

-- ä¹Ÿå¯ä»¥æ ¹æ®å®é™…æŸ¥è¯¢éœ€æ±‚è°ƒæ•´ç´¢å¼•é¡ºåº
CREATE INDEX idx_student_no ON students (student_no);
```

#### 4.2.2 å»ºè®®ç´¢å¼•
æ‰€æœ‰ä¸šåŠ¡è¡¨å»ºè®®åŒ…å«ï¼š
- ä¸»é”®ç´¢å¼•ï¼ˆUUIDï¼‰
- `school_id` ç´¢å¼•ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
- å¸¸ç”¨æŸ¥è¯¢å­—æ®µçš„å¤åˆç´¢å¼•

### 4.3 æ•°æ®åº“å˜æ›´è§„èŒƒ

#### 4.3.1 å˜æ›´æµç¨‹
- **ç¦æ­¢æ‰‹åŠ¨ä¿®æ”¹**ï¼šä¸¥ç¦é€šè¿‡ SQL å®¢æˆ·ç«¯ï¼ˆpgAdminã€DBeaverï¼‰æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“ç»“æ„
- **å”¯ä¸€æ–¹å¼**ï¼šå¿…é¡»é€šè¿‡ä¿®æ”¹ Ent Schema æ–‡ä»¶ï¼Œç”±æ¶æ„å¸ˆç»Ÿä¸€æ‰§è¡Œç‰ˆæœ¬åŒ–çš„ Migration
- **å®¡æ ¸æœºåˆ¶**ï¼šæ‰€æœ‰ Schema å˜æ›´å¿…é¡»æäº¤ Merge Requestï¼Œç»æ¶æ„å¸ˆ Code Review åæ–¹å¯åˆå¹¶

#### 4.3.2 è¿ç§»è„šæœ¬ç®¡ç†
- è¿ç§»è„šæœ¬ç»Ÿä¸€æ”¾åœ¨ `data/migration/` ç›®å½•
- è¿ç§»æ–‡ä»¶å‘½åè§„èŒƒï¼š`YYYYMMDD_HHMMSS_description.go`
- å¿…é¡»åŒæ—¶æä¾› `up` å’Œ `down` æ–¹æ³•

### 4.4 æ•°æ®ä¸€è‡´æ€§

#### 4.4.1 è·¨æœåŠ¡äº‹åŠ¡
æ¶‰åŠä¸åŒå¾®æœåŠ¡çš„æ“ä½œï¼ˆå¦‚ï¼šä» A æ ¡è°ƒæ‹¨è®¾å¤‡åˆ° B æ ¡ã€å­¦ç”Ÿè½¬å­¦ï¼‰å¿…é¡»ä½¿ç”¨ **DTM äº‹åŠ¡é©±åŠ¨**ï¼Œä¸¥ç¦åœ¨ä¸šåŠ¡ä»£ç ä¸­æ‰‹åŠ¨å¤„ç†è·¨åº“è¡¥å¿ã€‚

#### 4.4.2 DTM æ¨¡å¼é€‰æ‹©
- **SAGA æ¨¡å¼**ï¼šé€‚ç”¨äºé•¿äº‹åŠ¡ã€è¡¥å¿é€»è¾‘æ¸…æ™°çš„åœºæ™¯
- **TCC æ¨¡å¼**ï¼šé€‚ç”¨äºéœ€è¦é¢„ç•™èµ„æºçš„åœºæ™¯ï¼ˆå¦‚ï¼šé€‰è¯¾ã€èµ„äº§è°ƒæ‹¨ï¼‰

---

## 5. æƒé™æ¨¡å‹è§„èŒƒï¼ˆRBAC/ABAC + Casbinï¼‰

### 5.1 æƒé™æ¨¡å‹æ¦‚è¿°

ç³»ç»Ÿé‡‡ç”¨ **RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰+ ABACï¼ˆåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰** æ··åˆæ¨¡å‹ï¼Œä½¿ç”¨ **Casbin** ä½œä¸ºæƒé™å¼•æ“ï¼Œç»“åˆ Ent ORM å®ç°ç»†ç²’åº¦çš„æƒé™ç®¡ç†ã€‚

#### 5.1.1 æƒé™å±‚çº§

```
ç”¨æˆ· (User)
  â†“ æ‹¥æœ‰
è§’è‰² (Role)
  â†“ å…·å¤‡
æƒé™ (Permission)
  â†“ ä½œç”¨äº
èµ„æº (Resource) + æ“ä½œ (Action)
```

#### 5.1.2 å­¦æ ¡æƒé™ç®¡ç†

**æ•°æ®ç»„ç»‡è®¾è®¡**ï¼š
- **Permission è¡¨ï¼ˆå…¨å±€å…±äº«ï¼‰**ï¼šé›†å›¢ç»Ÿä¸€å®šä¹‰ï¼Œæ‰€æœ‰å­¦æ ¡å…±äº«
- **Role è¡¨ï¼ˆå­¦æ ¡çº§åˆ«ï¼‰**ï¼šæ¯ä¸ªå­¦æ ¡å¯åˆ›å»ºè‡ªå·±çš„è§’è‰²ï¼Œé€šè¿‡school_idå…³è”å­¦æ ¡
- **UserRole è¡¨ï¼ˆå­¦æ ¡çº§åˆ«ï¼‰**ï¼šç”¨æˆ·-è§’è‰²å…³ç³»é€šè¿‡school_idå…³è”å­¦æ ¡

**æƒé™æ£€æŸ¥è§„åˆ™**ï¼š
- **å­¦æ ¡ç”¨æˆ·**ï¼šåªèƒ½ç®¡ç†æœ¬æ ¡ï¼ˆschool_idï¼‰çš„è§’è‰²å’Œç”¨æˆ·è§’è‰²å…³è”
- **é›†å›¢ç®¡ç†å‘˜**ï¼š
  - å¯ä»¥ç®¡ç†å…¨å±€ Permissionï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
  - å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å­¦æ ¡çš„ Role å’Œ UserRoleï¼ˆé€šè¿‡ X-View-Scopeï¼‰
  - ä¸èƒ½ç›´æ¥ä¿®æ”¹å­¦æ ¡çš„ Role å’Œ UserRoleï¼ˆé™¤éæœ‰æ˜ç¡®æˆæƒï¼‰

**æ•°æ®æµè½¬ç¤ºä¾‹**ï¼š
```
1. é›†å›¢ç®¡ç†å‘˜åˆ›å»ºæƒé™ â†’ Permission è¡¨ï¼ˆå…¨å±€ï¼‰
   - student:create
   - student:read
   - student:update

2. å­¦æ ¡ A åˆ›å»ºè§’è‰² â†’ Role è¡¨ï¼ˆschool_id=school-aï¼‰
   - è§’è‰²"ç­ä¸»ä»»"å…³è”æƒé™ï¼šstudent:read, student:update

3. å­¦æ ¡ B åˆ›å»ºè§’è‰² â†’ Role è¡¨ï¼ˆschool_id=school-bï¼‰
   - è§’è‰²"ç­ä¸»ä»»"å…³è”æƒé™ï¼šstudent:read, student:update, student:delete

4. å­¦æ ¡ç”¨æˆ·åˆ†é…è§’è‰² â†’ UserRole è¡¨ï¼ˆschool_id=school-a/bï¼‰
   - å¼ è€å¸ˆï¼ˆschool-aï¼‰â†’ ç­ä¸»ä»»è§’è‰²ï¼ˆschool-aï¼‰
   - æè€å¸ˆï¼ˆschool-bï¼‰â†’ ç­ä¸»ä»»è§’è‰²ï¼ˆschool-bï¼‰
```

**æ•°æ®ç‹¬ç«‹æ€§**ï¼š
- å­¦æ ¡ A å’Œå­¦æ ¡ B çš„"ç­ä¸»ä»»"è§’è‰²è™½ç„¶åç§°ç›¸åŒï¼Œä½†æ˜¯å®Œå…¨ç‹¬ç«‹çš„æ•°æ®
- å­¦æ ¡ A æ— æ³•çœ‹åˆ°æˆ–ä¿®æ”¹å­¦æ ¡ B çš„è§’è‰²é…ç½®
- é›†å›¢å¯ä»¥æŸ¥çœ‹æ±‡æ€»ç»Ÿè®¡ï¼ˆå¦‚ï¼šæœ‰å¤šå°‘å­¦æ ¡åˆ›å»ºäº†"ç­ä¸»ä»»"è§’è‰²ï¼‰

---

### 5.2 Ent Schema è®¾è®¡

#### 5.2.1 æ ¸å¿ƒæƒé™è¡¨

**Role è¡¨ï¼ˆè§’è‰²ï¼‰**ï¼š
```go
// data/schema/role.go
type Role struct {
    ent.Schema
}

func (Role) Mixin() []ent.Mixin {
    return []ent.Mixin{
        SchoolMixin{}, // å­¦æ ¡å…³è”
        TimeMixin{},
    }
}

func (Role) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New),

        field.String("name").
            NotEmpty().
            Comment("è§’è‰²åç§°ï¼Œå¦‚ï¼šæ ¡é•¿ã€ç­ä¸»ä»»ã€æ•™å¸ˆ"),

        field.String("code").
            NotEmpty().
            Comment("è§’è‰²ä»£ç ï¼Œå¦‚ï¼šprincipalã€teacher"),

        field.String("description").
            Optional().
            Comment("è§’è‰²æè¿°"),

        field.Enum("type").
            Values("SYSTEM", "CUSTOM").
            Default("CUSTOM").
            Comment("SYSTEM=ç³»ç»Ÿé¢„å®šä¹‰ï¼ŒCUSTOM=è‡ªå®šä¹‰"),

        field.Int("sort_order").
            Default(0).
            Comment("æ’åº"),

        field.Bool("is_active").
            Default(true).
            Comment("æ˜¯å¦å¯ç”¨"),
    }
}

func (Role) Edges() []ent.Edge {
    return []ent.Edge{
        // è§’è‰²æ‹¥æœ‰çš„æƒé™
        edge.To("permissions", Permission.Type),

        // æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·
        edge.From("users", User.Type).
            Ref("roles"),
    }
}

func (Role) Indexes() []ent.Index {
    return []ent.Index{
        index.Fields("school_id", "code").Unique(),
        index.Fields("school_id", "is_active"),
    }
}
```

**Permission è¡¨ï¼ˆæƒé™ï¼‰**ï¼š

**è®¾è®¡è¯´æ˜**ï¼šPermission è¡¨é‡‡ç”¨**å…¨å±€å…±äº«**è®¾è®¡ï¼Œä¸ä½¿ç”¨ SchoolMixinï¼ŒåŸå› å¦‚ä¸‹ï¼š
- é›†å›¢å±‚é¢ç»Ÿä¸€å®šä¹‰ç³»ç»Ÿæƒé™ï¼ˆå¦‚ï¼šstudent:create, teacher:readï¼‰
- æ‰€æœ‰å­¦æ ¡å…±äº«ç›¸åŒçš„æƒé™å®šä¹‰ï¼Œé¿å…é‡å¤æ•°æ®
- å­¦æ ¡é€šè¿‡ Role è¡¨å…³è” Permissionï¼Œå®ç°æƒé™å®šåˆ¶

```go
// data/schema/permission.go
type Permission struct {
    ent.Schema
}

// æ³¨æ„ï¼šPermission ä¸ä½¿ç”¨ SchoolMixinï¼Œä¸ºå…¨å±€å…±äº«è¡¨
func (Permission) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New),

        field.String("resource").
            NotEmpty().
            Comment("èµ„æºç±»å‹ï¼Œå¦‚ï¼šstudentã€teacherã€grade"),

        field.String("action").
            NotEmpty().
            Comment("æ“ä½œï¼Œå¦‚ï¼šcreateã€readã€updateã€deleteã€export"),

        field.String("description").
            Optional().
            Comment("æƒé™æè¿°"),

        field.String("resource_filter").
            Optional().
            Comment("èµ„æºè¿‡æ»¤æ¡ä»¶ï¼ŒJSONæ ¼å¼ï¼Œç”¨äºABAC"),

        field.Time("created_at").
            Immutable().
            Default(time.Now),
    }
}

func (Permission) Edges() []ent.Edge {
    return []ent.Edge{
        // æ‹¥æœ‰è¯¥æƒé™çš„è§’è‰²
        edge.From("roles", Role.Type).
            Ref("permissions"),
    }
}

func (Permission) Indexes() []ent.Index {
    return []ent.Index{
        index.Fields("resource", "action").Unique(),
    }
}
```

**UserRole è¡¨ï¼ˆç”¨æˆ·è§’è‰²å…³è”ï¼‰**ï¼š
```go
// data/schema/user_role.go
type UserRole struct {
    ent.Schema
}

func (UserRole) Mixin() []ent.Mixin {
    return []ent.Mixin{
        SchoolMixin{}, // å­¦æ ¡å…³è”
        TimeMixin{},
    }
}

func (UserRole) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New),
        field.UUID("user_id", uuid.UUID{}),
        field.UUID("role_id", uuid.UUID{}),

        field.UUID("scope_org_id", uuid.UUID{}).
            Optional().
            Nillable().
            Comment("æƒé™ä½œç”¨èŒƒå›´ï¼ˆç»„ç»‡IDï¼‰ï¼Œä¸ºç©ºè¡¨ç¤ºå…¨å±€"),

        field.Time("effective_from").
            Optional().
            Comment("ç”Ÿæ•ˆæ—¶é—´"),

        field.Time("effective_to").
            Optional().
            Nillable().
            Comment("å¤±æ•ˆæ—¶é—´"),
    }
}

func (UserRole) Edges() []ent.Edge {
    return []ent.Edge{
        edge.To("user", User.Type).
            Required().
            Unique().
            Field("user_id"),

        edge.To("role", Role.Type).
            Required().
            Unique().
            Field("role_id"),
    }
}

func (UserRole) Indexes() []ent.Index {
    return []ent.Index{
        // è”åˆå”¯ä¸€ç´¢å¼•ï¼šé˜²æ­¢åŒä¸€ç”¨æˆ·åœ¨åŒä¸€å­¦æ ¡ä¸‹è¢«é‡å¤åˆ†é…åŒä¸€è§’è‰²
        index.Fields("school_id", "user_id", "role_id").Unique(),

        // æ™®é€šç´¢å¼•ï¼šåŠ é€ŸæŸ¥è¯¢
        index.Fields("user_id"),
        index.Fields("role_id"),
    }
}
```

---

### 5.3 Casbin é›†æˆ

#### 5.3.1 Casbin æ¨¡å‹å®šä¹‰

**æ–‡ä»¶è·¯å¾„**ï¼š`deploy/casbin/model.conf`

```ini
[request_definition]
r = sub, obj, act, school

[policy_definition]
p = sub, obj, act, school

[role_definition]
g = _, _, _
g2 = _, _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub, r.school) && r.obj == p.obj && r.act == p.act && r.school == p.school
```

**è¯´æ˜**ï¼š
- `sub`ï¼šä¸»ä½“ï¼ˆç”¨æˆ·IDæˆ–è§’è‰²IDï¼‰
- `obj`ï¼šèµ„æºå¯¹è±¡ï¼ˆå¦‚ï¼šstudentã€gradeï¼‰
- `act`ï¼šæ“ä½œï¼ˆå¦‚ï¼šcreateã€readã€updateã€deleteï¼‰
- `school`ï¼šå­¦æ ¡ID
- `g`ï¼šç”¨æˆ·-è§’è‰²å…³ç³»
- `g2`ï¼šè§’è‰²-æƒé™å…³ç³»

#### 5.3.2 Casbin Adapterï¼ˆä½¿ç”¨ Entï¼‰

**è®¾è®¡è¯´æ˜**ï¼š
- æœ¬ Adapter é‡‡ç”¨**åªè¯»æ¨¡å¼**ï¼Œä»…æ”¯æŒä»æ•°æ®åº“åŠ è½½ç­–ç•¥
- ç­–ç•¥å˜æ›´é€šè¿‡ç›´æ¥ä¿®æ”¹ Ent æ•°æ®ï¼ˆRoleã€Permissionã€UserRoleï¼‰ï¼Œç„¶åè°ƒç”¨ `LoadPolicy()` é‡æ–°åŠ è½½
- ä¸æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ·»åŠ /åˆ é™¤ç­–ç•¥ï¼ˆCasbin çš„ AddPolicy/RemovePolicy æ–¹æ³•æœªå®ç°ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`core/casbin/ent_adapter.go`

```go
package casbin

import (
    "context"
    "fmt"

    "github.com/casbin/casbin/v2"
    "github.com/casbin/casbin/v2/model"
    "github.com/casbin/casbin/v2/persist"
    "your-project/data/ent"
)

// EntAdapter Ent é€‚é…å™¨ï¼ˆåªè¯»æ¨¡å¼ï¼‰
// ç­–ç•¥æ•°æ®æ¥æºäº Ent ç®¡ç†çš„ Roleã€Permissionã€UserRole è¡¨
// ä¸æ”¯æŒé€šè¿‡ Casbin API åŠ¨æ€ä¿®æ”¹ç­–ç•¥
type EntAdapter struct {
    client *ent.Client
}

// NewEntAdapter åˆ›å»º Ent é€‚é…å™¨
func NewEntAdapter(client *ent.Client) *EntAdapter {
    return &EntAdapter{client: client}
}

// LoadPolicy ä»æ•°æ®åº“åŠ è½½ç­–ç•¥
func (a *EntAdapter) LoadPolicy(model model.Model) error {
    ctx := context.Background()

    // åŠ è½½è§’è‰²-æƒé™å…³ç³»
    roles, err := a.client.Role.Query().
        WithPermissions().
        All(ctx)
    if err != nil {
        return err
    }

    for _, role := range roles {
        for _, perm := range role.Edges.Permissions {
            // p, role_id, resource, action, school_id
            // é›†å›¢è§’è‰²ä½¿ç”¨ "global"ï¼Œå­¦æ ¡è§’è‰²ä½¿ç”¨ school_id
            schoolStr := "global"
            if role.SchoolID != uuid.Nil {
                schoolStr = role.SchoolID.String()
            }

            line := fmt.Sprintf("p, %s, %s, %s, %s",
                role.ID.String(),
                perm.Resource,
                perm.Action,
                schoolStr,
            )
            persist.LoadPolicyLine(line, model)
        }
    }

    // åŠ è½½ç”¨æˆ·-è§’è‰²å…³ç³»
    userRoles, err := a.client.UserRole.Query().All(ctx)
    if err != nil {
        return err
    }

    for _, ur := range userRoles {
        // g, user_id, role_id, school_id
        schoolStr := "global"
        if ur.SchoolID != uuid.Nil {
            schoolStr = ur.SchoolID.String()
        }

        line := fmt.Sprintf("g, %s, %s, %s",
            ur.UserID.String(),
            ur.RoleID.String(),
            schoolStr,
        )
        persist.LoadPolicyLine(line, model)
    }

    return nil
}

// SavePolicy ä¿å­˜ç­–ç•¥åˆ°æ•°æ®åº“
// æ³¨æ„ï¼šæœªå®ç°ï¼Œç­–ç•¥å˜æ›´è¯·ç›´æ¥ä½¿ç”¨ Ent API ä¿®æ”¹æ•°æ®åº“
func (a *EntAdapter) SavePolicy(model model.Model) error {
    return fmt.Errorf("SavePolicy not implemented: use Ent API to modify Role/Permission/UserRole directly")
}

// AddPolicy æ·»åŠ ç­–ç•¥
// æ³¨æ„ï¼šæœªå®ç°ï¼Œè¯·ä½¿ç”¨ Ent API æ·»åŠ  Role æˆ– UserRole
func (a *EntAdapter) AddPolicy(sec string, ptype string, rule []string) error {
    return fmt.Errorf("AddPolicy not implemented: use Ent API to create Role/UserRole")
}

// RemovePolicy åˆ é™¤ç­–ç•¥
// æ³¨æ„ï¼šæœªå®ç°ï¼Œè¯·ä½¿ç”¨ Ent API åˆ é™¤ Role æˆ– UserRole
func (a *EntAdapter) RemovePolicy(sec string, ptype string, rule []string) error {
    return fmt.Errorf("RemovePolicy not implemented: use Ent API to delete Role/UserRole")
}

// RemoveFilteredPolicy åˆ é™¤ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„ç­–ç•¥
// æ³¨æ„ï¼šæœªå®ç°ï¼Œè¯·ä½¿ç”¨ Ent Query æŸ¥è¯¢ååˆ é™¤
func (a *EntAdapter) RemoveFilteredPolicy(sec string, ptype string, fieldIndex int, fieldValues ...string) error {
    return fmt.Errorf("RemoveFilteredPolicy not implemented: use Ent Query API")
}
```

**ä½¿ç”¨è¯´æ˜**ï¼š
1. **åˆå§‹åŒ–æ—¶åŠ è½½ç­–ç•¥**ï¼š
   ```go
   adapter := NewEntAdapter(entClient)
   enforcer, _ := casbin.NewEnforcer("model.conf", adapter)
   enforcer.LoadPolicy() // ä»æ•°æ®åº“åŠ è½½
   ```

2. **ç­–ç•¥å˜æ›´æµç¨‹**ï¼š
   ```go
   // 1. ä½¿ç”¨ Ent API ä¿®æ”¹æ•°æ®
   client.Role.Create().SetName("æ–°è§’è‰²").Save(ctx)

   // 2. é‡æ–°åŠ è½½ç­–ç•¥åˆ° Casbin
   enforcer.LoadPolicy()
   ```

3. **å®šæœŸåˆ·æ–°ç­–ç•¥**ï¼ˆæ¨èï¼‰ï¼š
   ```go
   go func() {
       ticker := time.NewTicker(5 * time.Minute)
       for range ticker.C {
           enforcer.LoadPolicy()
       }
   }()
   ```

---

#### 5.3.3 æƒé™æ£€æŸ¥ä¸­é—´ä»¶

**æ–‡ä»¶è·¯å¾„**ï¼š`core/middleware/casbin_middleware.go`

```go
package middleware

import (
    "net/http"

    "github.com/casbin/casbin/v2"
    "github.com/google/uuid"
    "github.com/zeromicro/go-zero/core/logx"
    "github.com/zeromicro/go-zero/rest/httpx"
)

// CasbinMiddleware Casbin æƒé™æ£€æŸ¥ä¸­é—´ä»¶
func CasbinMiddleware(enforcer *casbin.Enforcer, resource, action string) func(http.HandlerFunc) http.HandlerFunc {
    return func(next http.HandlerFunc) http.HandlerFunc {
        return func(w http.ResponseWriter, r *http.Request) {
            ctx := r.Context()

            // ä» Context è·å–ç”¨æˆ·ä¿¡æ¯
            userID, ok := ctx.Value("user_id").(string)
            if !ok {
                httpx.Error(w, &httpx.CodeError{
                    Code: http.StatusUnauthorized,
                    Msg:  "unauthorized",
                })
                return
            }

            // ä» Context è·å–å­¦æ ¡ID
            schoolID, ok := ctx.Value("school_id").(uuid.UUID)
            if !ok {
                httpx.Error(w, &httpx.CodeError{
                    Code: http.StatusUnauthorized,
                    Msg:  "missing school context",
                })
                return
            }

            // ç‰¹æ®Šå¤„ç†ï¼šé›†å›¢ç”¨æˆ·å…¨å±€æ¨¡å¼ï¼ˆschool_id ä¸º uuid.Nilï¼‰
            userType, _ := ctx.Value("user_type").(string)
            if userType == "GROUP" && schoolID == uuid.Nil {
                // é›†å›¢ç”¨æˆ·åœ¨å…¨å±€æ¨¡å¼ä¸‹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€æƒé™
                // ä½¿ç”¨ç‰¹æ®Šçš„ school å€¼ "global" è¿›è¡Œæƒé™æ£€æŸ¥
                allowed, err := enforcer.Enforce(
                    userID,
                    resource,
                    action,
                    "global", // é›†å›¢å…¨å±€æƒé™ä½¿ç”¨ç‰¹æ®Šæ ‡è¯†
                )

                if err != nil {
                    logx.WithContext(ctx).Errorf("casbin enforce error: %v", err)
                    httpx.Error(w, &httpx.CodeError{
                        Code: http.StatusInternalServerError,
                        Msg:  "permission check failed",
                    })
                    return
                }

                if !allowed {
                    httpx.Error(w, &httpx.CodeError{
                        Code: http.StatusForbidden,
                        Msg:  "permission denied",
                    })
                    return
                }

                // é›†å›¢ç”¨æˆ·å…¨å±€æƒé™æ£€æŸ¥é€šè¿‡
                next(w, r.WithContext(ctx))
                return
            }

            // å¸¸è§„æƒé™æ£€æŸ¥ï¼ˆå­¦æ ¡ç”¨æˆ·æˆ–é›†å›¢ä»£ç®¡æ¨¡å¼ï¼‰
            // sub, obj, act, school
            allowed, err := enforcer.Enforce(
                userID,
                resource,
                action,
                schoolID.String(),
            )

            if err != nil {
                logx.WithContext(ctx).Errorf("casbin enforce error: %v", err)
                httpx.Error(w, &httpx.CodeError{
                    Code: http.StatusInternalServerError,
                    Msg:  "permission check failed",
                })
                return
            }

            if !allowed {
                httpx.Error(w, &httpx.CodeError{
                    Code: http.StatusForbidden,
                    Msg:  "permission denied",
                })
                return
            }

            // æƒé™æ£€æŸ¥é€šè¿‡ï¼Œç»§ç»­å¤„ç†
            next(w, r.WithContext(ctx))
        }
    }
}
```

---

### 5.4 API ä½¿ç”¨ç¤ºä¾‹

#### 5.4.1 åœ¨ .api æ–‡ä»¶ä¸­ä½¿ç”¨

```go
// manifests/api/student.api

@server(
    jwt: Auth
    middleware: SchoolInterceptor, CasbinMiddleware(student, create)
    group: student
)
service educational-api {
    @doc "åˆ›å»ºå­¦ç”Ÿ"
    @handler StudentCreate
    post /api/v1/students (StudentCreateRequest) returns (StudentCreateResponse)
}

@server(
    jwt: Auth
    middleware: SchoolInterceptor, CasbinMiddleware(student, read)
    group: student
)
service educational-api {
    @doc "å­¦ç”Ÿåˆ—è¡¨"
    @handler StudentList
    get /api/v1/students (StudentListRequest) returns (StudentListResponse)
}
```

#### 5.4.2 åœ¨ä»£ç ä¸­åŠ¨æ€æ£€æŸ¥æƒé™

```go
// logic/student_create_logic.go

func (l *StudentCreateLogic) StudentCreate(req *types.StudentCreateRequest) (*types.StudentCreateResponse, error) {
    ctx := l.ctx

    // ä» Context è·å–ç”¨æˆ·ID
    userID := ctx.Value("user_id").(string)
    schoolID := ctx.Value("school_id").(uuid.UUID)

    // åŠ¨æ€æƒé™æ£€æŸ¥ï¼ˆå¦‚éœ€è¦ï¼‰
    allowed, err := l.svcCtx.Enforcer.Enforce(
        userID,
        "student",
        "create",
        schoolID.String(),
    )

    if !allowed {
        return nil, errors.New("permission denied")
    }

    // ä¸šåŠ¡é€»è¾‘...

    return &types.StudentCreateResponse{
        Id: student.ID.String(),
    }, nil
}
```

---

### 5.5 é¢„å®šä¹‰è§’è‰²ä¸æƒé™

#### 5.5.1 ç³»ç»Ÿé¢„å®šä¹‰è§’è‰²

| è§’è‰²ä»£ç  | è§’è‰²åç§° | æƒé™èŒƒå›´ | school_id | è¯´æ˜ |
|---------|---------|---------|-----------|------|
| `group_admin` | é›†å›¢ç®¡ç†å‘˜ | å…¨å±€ | globalï¼ˆç‰¹æ®Šå€¼ï¼‰ | å¯ç®¡ç†æ‰€æœ‰å­¦æ ¡æ•°æ®ï¼Œè®¿é—®å…¨å±€ Permission |
| `school_admin` | å­¦æ ¡ç®¡ç†å‘˜ | å­¦æ ¡çº§ | å­¦æ ¡UUID | å¯ç®¡ç†æœ¬æ ¡æ‰€æœ‰æ•°æ® |
| `principal` | æ ¡é•¿ | å­¦æ ¡çº§ | å­¦æ ¡UUID | å­¦æ ¡æœ€é«˜ç®¡ç†æƒé™ |
| `dean` | æ•™åŠ¡ä¸»ä»» | å­¦æ ¡çº§ | å­¦æ ¡UUID | æ•™åŠ¡ç®¡ç†æƒé™ |
| `teacher` | æ•™å¸ˆ | ç­çº§çº§ | å­¦æ ¡UUID | å¯ç®¡ç†æ‰€æ•™ç­çº§å­¦ç”Ÿ |
| `class_teacher` | ç­ä¸»ä»» | ç­çº§çº§ | å­¦æ ¡UUID | å¯ç®¡ç†æ‰€å¸¦ç­çº§ |
| `student` | å­¦ç”Ÿ | ä¸ªäººçº§ | å­¦æ ¡UUID | åªèƒ½æŸ¥çœ‹ä¸ªäººä¿¡æ¯ |
| `parent` | å®¶é•¿ | ä¸ªäººçº§ | å­¦æ ¡UUID | åªèƒ½æŸ¥çœ‹å­å¥³ä¿¡æ¯ |

**é›†å›¢ç®¡ç†å‘˜ç‰¹æ®Šè¯´æ˜**ï¼š
- `group_admin` è§’è‰²åœ¨ Casbin ç­–ç•¥ä¸­ä½¿ç”¨ `school="global"` è¿›è¡Œæƒé™æ£€æŸ¥
- é›†å›¢ç®¡ç†å‘˜å¯ä»¥ï¼š
  - ç®¡ç†å…¨å±€ Permissionï¼ˆCRUD æ“ä½œï¼‰
  - æŸ¥çœ‹æ‰€æœ‰å­¦æ ¡çš„ Role ç»Ÿè®¡ï¼ˆåªè¯»ï¼‰
  - é€šè¿‡ `X-View-Scope` åˆ‡æ¢åˆ°ç‰¹å®šå­¦æ ¡è§†è§’è¿›è¡Œç®¡ç†
- é›†å›¢ç®¡ç†å‘˜**ä¸èƒ½**ç›´æ¥ä¿®æ”¹å­¦æ ¡çš„ Role å’Œ UserRoleï¼ˆå¿…é¡»åˆ‡æ¢åˆ°è¯¥å­¦æ ¡è§†è§’ï¼‰

#### 5.5.2 èµ„æºä¸æ“ä½œå®šä¹‰

**èµ„æºç±»å‹**ï¼š
- `student`ï¼šå­¦ç”Ÿç®¡ç†
- `teacher`ï¼šæ•™å¸ˆç®¡ç†
- `course`ï¼šè¯¾ç¨‹ç®¡ç†
- `grade`ï¼šæˆç»©ç®¡ç†
- `attendance`ï¼šè€ƒå‹¤ç®¡ç†
- `organization`ï¼šç»„ç»‡æ¶æ„ç®¡ç†
- `role`ï¼šè§’è‰²ç®¡ç†
- `permission`ï¼šæƒé™ç®¡ç†

**æ“ä½œç±»å‹**ï¼š
- `create`ï¼šåˆ›å»º
- `read`ï¼šæŸ¥çœ‹
- `update`ï¼šæ›´æ–°
- `delete`ï¼šåˆ é™¤
- `export`ï¼šå¯¼å‡º
- `import`ï¼šå¯¼å…¥
- `approve`ï¼šå®¡æ‰¹

#### 5.5.3 åˆå§‹åŒ–æƒé™è„šæœ¬

**æ–‡ä»¶è·¯å¾„**ï¼š`scripts/init_permissions.go`

```go
package main

import (
    "context"
    "log"

    "github.com/google/uuid"
    "your-project/data/ent"
)

func main() {
    client, err := ent.Open("postgres", "postgresql://...")
    if err != nil {
        log.Fatal(err)
    }
    defer client.Close()

    ctx := context.Background()

    // 1. åˆ›å»ºå…¨å±€ç³»ç»Ÿæƒé™ï¼ˆPermission è¡¨ï¼Œæ—  school_idï¼‰
    permissions := []struct {
        Resource string
        Action   string
        Desc     string
    }{
        {"student", "create", "åˆ›å»ºå­¦ç”Ÿ"},
        {"student", "read", "æŸ¥çœ‹å­¦ç”Ÿ"},
        {"student", "update", "æ›´æ–°å­¦ç”Ÿ"},
        {"student", "delete", "åˆ é™¤å­¦ç”Ÿ"},
        {"student", "export", "å¯¼å‡ºå­¦ç”Ÿ"},
        {"student", "import", "å¯¼å…¥å­¦ç”Ÿ"},

        {"teacher", "create", "åˆ›å»ºæ•™å¸ˆ"},
        {"teacher", "read", "æŸ¥çœ‹æ•™å¸ˆ"},
        {"teacher", "update", "æ›´æ–°æ•™å¸ˆ"},
        {"teacher", "delete", "åˆ é™¤æ•™å¸ˆ"},

        {"permission", "create", "åˆ›å»ºæƒé™"},
        {"permission", "read", "æŸ¥çœ‹æƒé™"},
        {"permission", "update", "æ›´æ–°æƒé™"},
        {"permission", "delete", "åˆ é™¤æƒé™"},

        // ... æ›´å¤šæƒé™
    }

    permissionIDs := make(map[string]uuid.UUID)
    for _, p := range permissions {
        perm, err := client.Permission.Create().
            SetResource(p.Resource).
            SetAction(p.Action).
            SetDescription(p.Desc).
            Save(ctx)
        if err != nil {
            log.Printf("create permission failed: %v", err)
            continue
        }
        key := p.Resource + ":" + p.Action
        permissionIDs[key] = perm.ID
    }

    // 2. åˆ›å»ºé›†å›¢ç®¡ç†å‘˜è§’è‰²ï¼ˆä½¿ç”¨ç‰¹æ®Šçš„ school_idï¼‰
    // æ³¨æ„ï¼šé›†å›¢è§’è‰²éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡Œä½¿ç”¨ uuid.Nil æˆ–ç‰¹å®šçš„é›†å›¢UUID
    groupAdminRole, err := client.Role.Create().
        SetSchoolID(uuid.Nil). // é›†å›¢è§’è‰²ä½¿ç”¨ Nil ä½œä¸ºç‰¹æ®Šæ ‡è¯†
        SetName("é›†å›¢ç®¡ç†å‘˜").
        SetCode("group_admin").
        SetType("SYSTEM").
        SetDescription("é›†å›¢æœ€é«˜ç®¡ç†æƒé™ï¼Œå¯ç®¡ç†æ‰€æœ‰å­¦æ ¡").
        AddPermissionIDs(
            permissionIDs["permission:create"],
            permissionIDs["permission:read"],
            permissionIDs["permission:update"],
            permissionIDs["permission:delete"],
            // é›†å›¢ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
        ).
        Save(ctx)
    if err != nil {
        log.Fatalf("create group_admin role failed: %v", err)
    }

    log.Printf("Group admin role created: %s", groupAdminRole.ID)
    log.Println("Permissions initialized successfully")
}
```

**åˆå§‹åŒ–è¯´æ˜**ï¼š
- Permission è¡¨æ˜¯å…¨å±€å…±äº«çš„ï¼Œä¸éœ€è¦ school_id
- é›†å›¢ç®¡ç†å‘˜è§’è‰²ä½¿ç”¨ `uuid.Nil` ä½œä¸º school_id çš„ç‰¹æ®Šæ ‡è¯†
- å­¦æ ¡çº§è§’è‰²ç”±å„å­¦æ ¡è‡ªè¡Œåˆ›å»ºï¼Œä½¿ç”¨å„è‡ªçš„ school_id

---

### 5.6 ABAC æ‰©å±•ï¼ˆåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰

#### 5.6.1 åœºæ™¯ç¤ºä¾‹

**åœºæ™¯**ï¼šç­ä¸»ä»»åªèƒ½ç®¡ç†è‡ªå·±ç­çº§çš„å­¦ç”Ÿ

**å®ç°æ–¹å¼**ï¼š

1. **åœ¨ UserRole ä¸­å¢åŠ  scope_org_id**ï¼š
   ```go
   // å¼ è€å¸ˆæ˜¯ 1ç­ çš„ç­ä¸»ä»»
   UserRole {
       UserID: "zhang-teacher-uuid",
       RoleID: "class-teacher-role-uuid",
       ScopeOrgID: "class-1-uuid",  // æƒé™ä½œç”¨èŒƒå›´
   }
   ```

2. **åœ¨æƒé™æ£€æŸ¥æ—¶éªŒè¯ä½œç”¨åŸŸ**ï¼š
   ```go
   // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®æŸä¸ªå­¦ç”Ÿ
   func (l *StudentUpdateLogic) checkPermission(studentID uuid.UUID) bool {
       // 1. æŸ¥è¯¢å­¦ç”Ÿæ‰€å±ç­çº§
       student, _ := l.svcCtx.DB.Student.Get(l.ctx, studentID)
       studentClassID := student.ClassID

       // 2. æŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²ä½œç”¨åŸŸ
       userID := l.ctx.Value("user_id").(string)
       userRoles, _ := l.svcCtx.DB.UserRole.Query().
           Where(userrole.UserIDEQ(uuid.MustParse(userID))).
           All(l.ctx)

       // 3. æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„ä½œç”¨åŸŸ
       for _, ur := range userRoles {
           if ur.ScopeOrgID != nil && *ur.ScopeOrgID == studentClassID {
               return true
           }
       }

       return false
   }
   ```

#### 5.6.2 æ¨èå®ç°æ–¹å¼ï¼ˆä¸šåŠ¡å±‚æ ¡éªŒï¼‰

**è®¾è®¡åŸåˆ™**ï¼š
- **ä¸ä½¿ç”¨ Casbin ABAC çš„ eval() å‡½æ•°**ï¼ˆå­˜åœ¨æ€§èƒ½å’Œå®‰å…¨é—®é¢˜ï¼‰
- **åœ¨ä¸šåŠ¡å±‚è¿›è¡Œä½œç”¨åŸŸæ ¡éªŒ**ï¼Œé€»è¾‘æ¸…æ™°ã€æ˜“äºç»´æŠ¤
- **Casbin ä»…è´Ÿè´£åŸºç¡€çš„ RBAC æƒé™æ£€æŸ¥**ï¼ˆç”¨æˆ·æ˜¯å¦æœ‰è¯¥èµ„æºçš„æ“ä½œæƒé™ï¼‰

**å®ç°æµç¨‹**ï¼š

1. **Casbin æ£€æŸ¥åŸºç¡€æƒé™**ï¼ˆæ˜¯å¦æœ‰ student:update æƒé™ï¼‰
2. **ä¸šåŠ¡å±‚æ£€æŸ¥ä½œç”¨åŸŸ**ï¼ˆæ˜¯å¦æœ‰æƒé™æ“ä½œè¿™ä¸ªå…·ä½“çš„å­¦ç”Ÿï¼‰

**å®Œæ•´ä»£ç ç¤ºä¾‹**ï¼š

```go
// apps/educational/api/internal/logic/student/updatestudentlogic.go
func (l *UpdateStudentLogic) UpdateStudent(req *types.UpdateStudentRequest) error {
    userID := ctxdata.GetUserID(l.ctx)

    // ç¬¬ä¸€æ­¥ï¼šCasbin æ£€æŸ¥åŸºç¡€æƒé™
    allowed, err := l.svcCtx.Enforcer.Enforce(
        userID,
        "student",
        "update",
        ctxdata.GetSchoolID(l.ctx).String(),
    )
    if !allowed {
        return errors.New("permission denied: no student:update permission")
    }

    // ç¬¬äºŒæ­¥ï¼šä¸šåŠ¡å±‚æ£€æŸ¥ä½œç”¨åŸŸï¼ˆå¦‚æœç”¨æˆ·è§’è‰²æœ‰ scope_org_idï¼‰
    hasScope, err := l.checkScopePermission(userID, req.StudentID)
    if !hasScope {
        return errors.New("permission denied: student not in your scope")
    }

    // æ‰§è¡Œæ›´æ–°æ“ä½œ
    return l.svcCtx.DB.Student.UpdateOneID(req.StudentID).
        SetName(req.Name).
        Exec(l.ctx)
}

// checkScopePermission æ£€æŸ¥ç”¨æˆ·çš„ä½œç”¨åŸŸæƒé™
func (l *UpdateStudentLogic) checkScopePermission(userID string, studentID uuid.UUID) (bool, error) {
    // æŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²ä½œç”¨åŸŸ
    userRoles, err := l.svcCtx.DB.UserRole.Query().
        Where(userrole.UserIDEQ(uuid.MustParse(userID))).
        All(l.ctx)
    if err != nil {
        return false, err
    }

    // å¦‚æœç”¨æˆ·çš„æ‰€æœ‰è§’è‰²éƒ½æ²¡æœ‰è®¾ç½® scope_org_idï¼Œè¯´æ˜æœ‰å…¨å±€æƒé™
    hasGlobalRole := false
    scopeOrgIDs := make([]uuid.UUID, 0)

    for _, ur := range userRoles {
        if ur.ScopeOrgID == nil {
            hasGlobalRole = true
            break
        }
        scopeOrgIDs = append(scopeOrgIDs, *ur.ScopeOrgID)
    }

    if hasGlobalRole {
        return true, nil // æœ‰å…¨å±€æƒé™ï¼ˆå¦‚æ ¡é•¿ï¼‰
    }

    // æŸ¥è¯¢å­¦ç”Ÿæ‰€å±çš„ç»„ç»‡ï¼ˆç­çº§ï¼‰
    student, err := l.svcCtx.DB.Student.Query().
        Where(student.IDEQ(studentID)).
        WithClass().  // å…³è”æŸ¥è¯¢ç­çº§
        Only(l.ctx)
    if err != nil {
        return false, err
    }

    // æ£€æŸ¥å­¦ç”Ÿçš„ç­çº§æ˜¯å¦åœ¨ç”¨æˆ·çš„ä½œç”¨åŸŸèŒƒå›´å†…
    for _, scopeID := range scopeOrgIDs {
        if student.Edges.Class.ID == scopeID {
            return true, nil
        }
    }

    return false, nil
}
```

**ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **Casbin eval()** | é…ç½®çµæ´» | 1. æ€§èƒ½å·®ï¼ˆæ¯æ¬¡è§£æè¡¨è¾¾å¼ï¼‰<br>2. å®‰å…¨é£é™©ï¼ˆè¡¨è¾¾å¼æ³¨å…¥ï¼‰<br>3. éš¾ä»¥è°ƒè¯• |
| **ä¸šåŠ¡å±‚æ ¡éªŒï¼ˆæ¨èï¼‰** | 1. æ€§èƒ½å¥½ï¼ˆç›´æ¥æŸ¥è¯¢ï¼‰<br>2. å®‰å…¨å¯æ§<br>3. é€»è¾‘æ¸…æ™°æ˜“ç»´æŠ¤<br>4. ä¾¿äºå•å…ƒæµ‹è¯• | éœ€è¦åœ¨æ¯ä¸ª Logic ä¸­æ‰‹åŠ¨ç¼–å†™ |

**æœ€ä½³å®è·µ**ï¼š
- å°† `checkScopePermission` é€»è¾‘å°è£…ä¸º**å…¬å…±å‡½æ•°**ï¼ˆ`core/permission/scope.go`ï¼‰
- é€šè¿‡**ä»£ç ç”Ÿæˆ**è‡ªåŠ¨ä¸ºéœ€è¦ä½œç”¨åŸŸæ ¡éªŒçš„æ¥å£æ·»åŠ æ£€æŸ¥é€»è¾‘
- åœ¨ **Code Review** æ—¶é‡ç‚¹æ£€æŸ¥ä½œç”¨åŸŸæ ¡éªŒæ˜¯å¦é—æ¼

---

### 5.7 æƒé™ç®¡ç† API

#### 5.7.1 è§’è‰²ç®¡ç† API

```go
// åˆ›å»ºè§’è‰²
POST /api/v1/roles
{
    "name": "å¹´çº§ä¸»ä»»",
    "code": "grade_director",
    "description": "ç®¡ç†æ•´ä¸ªå¹´çº§çš„æ•™åŠ¡",
    "permissions": ["student:read", "student:update", "grade:create"]
}

// åˆ†é…è§’è‰²ç»™ç”¨æˆ·
POST /api/v1/users/{user_id}/roles
{
    "role_id": "role-uuid",
    "scope_org_id": "grade-1-uuid",  // å¯é€‰ï¼šæƒé™ä½œç”¨èŒƒå›´
    "effective_from": "2025-01-01T00:00:00Z",
    "effective_to": "2025-12-31T23:59:59Z"
}

// æŸ¥è¯¢ç”¨æˆ·æƒé™
GET /api/v1/users/{user_id}/permissions
```

#### 5.7.2 æƒé™æ£€æŸ¥ API

```go
// æ£€æŸ¥æƒé™
POST /api/v1/permissions/check
{
    "user_id": "user-uuid",
    "resource": "student",
    "action": "update",
    "resource_id": "student-uuid"  // å¯é€‰ï¼šå…·ä½“èµ„æºID
}

// è¿”å›
{
    "allowed": true,
    "reason": ""
}
```

---

### 5.8 å¼€å‘è§„èŒƒ

#### 5.8.1 æƒé™æ£€æŸ¥è§„èŒƒ

**å¿…é¡»æ£€æŸ¥æƒé™çš„åœºæ™¯**ï¼š
- âœ… æ‰€æœ‰æ•°æ®çš„å¢åˆ æ”¹æ“ä½œ
- âœ… æ•æ„Ÿæ•°æ®çš„æŸ¥è¯¢ï¼ˆå¦‚æˆç»©ã€ä¸ªäººä¿¡æ¯ï¼‰
- âœ… æ‰¹é‡æ“ä½œï¼ˆå¯¼å…¥ã€å¯¼å‡ºï¼‰
- âœ… ç³»ç»Ÿé…ç½®ä¿®æ”¹

**å¯ä»¥è·³è¿‡æƒé™æ£€æŸ¥çš„åœºæ™¯**ï¼š
- âœ… å…¬å¼€æ•°æ®æŸ¥è¯¢ï¼ˆå¦‚è¯¾ç¨‹è¡¨ï¼‰
- âœ… ç”¨æˆ·ä¸ªäººä¿¡æ¯æŸ¥è¯¢ï¼ˆè‡ªå·±çš„ï¼‰

**æ—¶é—´èŒƒå›´æƒé™æ£€æŸ¥**ï¼š

UserRole è¡¨çš„ `effective_from` å’Œ `effective_to` å­—æ®µç”¨äºé™åˆ¶è§’è‰²çš„ç”Ÿæ•ˆæ—¶é—´èŒƒå›´ï¼Œå…¸å‹åœºæ™¯ï¼š
- ä¸´æ—¶ä»£è¯¾æ•™å¸ˆï¼ˆåªåœ¨æŸå­¦æœŸæœ‰æƒé™ï¼‰
- å®ä¹ æ•™å¸ˆï¼ˆå®ä¹ æœŸé—´çš„æƒé™ï¼‰
- ä¸´æ—¶ç®¡ç†å‘˜ï¼ˆæ´»åŠ¨æœŸé—´çš„æƒé™ï¼‰

**å®ç°æ–¹å¼**ï¼š

1. **åœ¨ EntAdapter åŠ è½½ç­–ç•¥æ—¶è¿‡æ»¤**ï¼š
   ```go
   func (a *EntAdapter) LoadPolicy(model model.Model) error {
       ctx := context.Background()
       now := time.Now()

       // åŠ è½½ç”¨æˆ·-è§’è‰²å…³ç³»ï¼Œè¿‡æ»¤æ—¶é—´èŒƒå›´
       userRoles, err := a.client.UserRole.Query().
           Where(
               // æ£€æŸ¥ effective_fromï¼šä¸ºç©ºæˆ–å°äºç­‰äºå½“å‰æ—¶é—´
               userrole.Or(
                   userrole.EffectiveFromIsNil(),
                   userrole.EffectiveFromLTE(now),
               ),
               // æ£€æŸ¥ effective_toï¼šä¸ºç©ºæˆ–å¤§äºå½“å‰æ—¶é—´
               userrole.Or(
                   userrole.EffectiveToIsNil(),
                   userrole.EffectiveToGT(now),
               ),
           ).
           All(ctx)
       // ... åŠ è½½ç­–ç•¥
   }
   ```

2. **åœ¨åˆ†é…è§’è‰²æ—¶æ ¡éªŒæ—¶é—´èŒƒå›´**ï¼š
   ```go
   func (l *AssignRoleLogic) AssignRole(req *types.AssignRoleRequest) error {
       // æ ¡éªŒæ—¶é—´èŒƒå›´
       if req.EffectiveFrom != nil && req.EffectiveTo != nil {
           if req.EffectiveTo.Before(*req.EffectiveFrom) {
               return errors.New("effective_to must be after effective_from")
           }
       }

       // åˆ›å»ºç”¨æˆ·è§’è‰²å…³è”
       userRole, err := l.svcCtx.DB.UserRole.Create().
           SetUserID(req.UserID).
           SetRoleID(req.RoleID).
           SetNillableEffectiveFrom(req.EffectiveFrom).
           SetNillableEffectiveTo(req.EffectiveTo).
           Save(l.ctx)

       // é‡æ–°åŠ è½½ Casbin ç­–ç•¥
       l.svcCtx.Enforcer.LoadPolicy()

       return nil
   }
   ```

3. **å®šæœŸåˆ·æ–°ç­–ç•¥ä»¥åº”ç”¨æ—¶é—´å˜åŒ–**ï¼š
   ```go
   // æ¯å°æ—¶åˆ·æ–°ä¸€æ¬¡ç­–ç•¥ï¼Œä½¿è¿‡æœŸçš„è§’è‰²å¤±æ•ˆ
   go func() {
       ticker := time.NewTicker(1 * time.Hour)
       for range ticker.C {
           enforcer.LoadPolicy()
           logx.Info("Casbin policy refreshed, expired roles removed")
       }
   }()
   ```

#### 5.8.2 æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜ Casbin Enforcer**ï¼š
   ```go
   // ä½¿ç”¨å•ä¾‹æ¨¡å¼ç¼“å­˜ Enforcer
   var (
       enforcer *casbin.Enforcer
       once     sync.Once
   )

   func GetEnforcer() *casbin.Enforcer {
       once.Do(func() {
           enforcer, _ = casbin.NewEnforcer("model.conf", adapter)
           enforcer.EnableCache(true)  // å¼€å¯ç¼“å­˜
       })
       return enforcer
   }
   ```

2. **å®šæœŸåˆ·æ–°ç­–ç•¥**ï¼š
   ```go
   // æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ç­–ç•¥
   go func() {
       ticker := time.NewTicker(5 * time.Minute)
       for range ticker.C {
           enforcer.LoadPolicy()
       }
   }()
   ```

3. **æ‰¹é‡æƒé™æ£€æŸ¥**ï¼š
   ```go
   // æ‰¹é‡æ£€æŸ¥æƒé™
   results := enforcer.BatchEnforce([][]interface{}{
       {userID, "student", "read", schoolID},
       {userID, "student", "update", schoolID},
       {userID, "student", "delete", schoolID},
   })
   ```

---

### 5.9 æµ‹è¯•è¦æ±‚

#### 5.9.1 æƒé™æµ‹è¯•ç”¨ä¾‹

**å¿…é¡»åŒ…å«çš„æµ‹è¯•**ï¼š
- âœ… ç”¨æˆ·æ‹¥æœ‰æƒé™æ—¶å¯ä»¥è®¿é—®èµ„æº
- âœ… ç”¨æˆ·æ— æƒé™æ—¶è¢«æ‹’ç»è®¿é—®
- âœ… è·¨æ ¡æƒé™éš”ç¦»ï¼ˆAæ ¡ç”¨æˆ·ä¸èƒ½è®¿é—®Bæ ¡æ•°æ®ï¼‰
- âœ… è§’è‰²ç»§æ‰¿æ­£ç¡®æ€§
- âœ… æ—¶é—´èŒƒå›´æƒé™ï¼ˆeffective_from/toï¼‰
- âœ… ä½œç”¨åŸŸæƒé™ï¼ˆscope_org_idï¼‰

**ç¤ºä¾‹æµ‹è¯•**ï¼š
```go
func TestPermissionCheck(t *testing.T) {
    // åˆ›å»ºæµ‹è¯•ç”¨æˆ·å’Œè§’è‰²
    user := createTestUser()
    role := createTestRole("teacher")
    assignRoleToUser(user.ID, role.ID)

    // æ·»åŠ æƒé™åˆ°è§’è‰²
    addPermissionToRole(role.ID, "student", "read")

    // æµ‹è¯•ï¼šç”¨æˆ·åº”è¯¥æœ‰è¯»æƒé™
    allowed := enforcer.Enforce(user.ID, "student", "read", schoolID)
    assert.True(t, allowed)

    // æµ‹è¯•ï¼šç”¨æˆ·åº”è¯¥æ²¡æœ‰åˆ é™¤æƒé™
    allowed = enforcer.Enforce(user.ID, "student", "delete", schoolID)
    assert.False(t, allowed)
}
```

---

## 6. å¼€å‘æµç¨‹ä¸ä»£ç è§„èŒƒ

### 6.1 Monorepo ç®¡ç†

#### 6.1.1 ç›®å½•ç»“æ„è§„èŒƒ
```
/edu-system
â”œâ”€â”€ apps/                # å¾®æœåŠ¡ä¸šåŠ¡ä»£ç 
â”‚   â”œâ”€â”€ organization/    # ç»„ç»‡æ¶æ„æœåŠ¡ (API & RPC)
â”‚   â”œâ”€â”€ auth/            # æƒé™ä¸èº«ä»½æœåŠ¡
â”‚   â”œâ”€â”€ educational/     # æ•™åŠ¡ç³»ç»ŸæœåŠ¡
â”‚   â””â”€â”€ gateway/         # ç»Ÿä¸€ç½‘å…³
â”œâ”€â”€ core/                # æ ¸å¿ƒå…¬å…±åº“
â”‚   â”œâ”€â”€ middleware/      # å­¦æ ¡æ‹¦æˆªå™¨ã€æ—¥å¿—æ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ respx/           # ç»Ÿä¸€å“åº”å¤„ç†
â”‚   â””â”€â”€ ctxdata/         # Context ä¿¡æ¯è§£æ
â”œâ”€â”€ data/                # æ•°æ®æŒä¹…å±‚
â”‚   â”œâ”€â”€ schema/          # Ent Schema å®šä¹‰
â”‚   â”œâ”€â”€ ent/             # Ent ç”Ÿæˆä»£ç 
â”‚   â””â”€â”€ migration/       # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ manifests/           # æ¥å£ä¸åè®®å®šä¹‰
â”‚   â”œâ”€â”€ api/             # go-zero .api æ–‡ä»¶
â”‚   â””â”€â”€ rpc/             # gRPC .proto æ–‡ä»¶
â”œâ”€â”€ deploy/              # éƒ¨ç½²ç›¸å…³
â”‚   â”œâ”€â”€ docker-compose/  # æœ¬åœ°å¼€å‘ç¯å¢ƒ
â”‚   â”œâ”€â”€ k8s/             # Kubernetes é…ç½®
â”‚   â””â”€â”€ nginx/           # Nginx é…ç½®
â”œâ”€â”€ scripts/             # å·¥å…·è„šæœ¬
â”œâ”€â”€ go.mod
â””â”€â”€ Makefile             # è‡ªåŠ¨åŒ–å‘½ä»¤
```

#### 6.1.2 å…¬å…±ä»£ç ç®¡ç†
- å…¬å…±ä»£ç ï¼ˆUUID å¤„ç†å·¥å…·ã€Context è§£æã€Ent Mixinï¼‰ç»Ÿä¸€æ”¾åœ¨ `/core` æˆ– `/data` ç›®å½•
- **ä¸¥ç¦å„å¾®æœåŠ¡é‡å¤é€ è½®å­**
- å…±äº«ä»£ç å¿…é¡»ç¼–å†™å•å…ƒæµ‹è¯•

### 6.2 Git å·¥ä½œæµè§„èŒƒ

#### 6.2.1 åˆ†æ”¯ç­–ç•¥
é‡‡ç”¨ **Git Flow** æ¨¡å¼ï¼š
- `main`ï¼šç”Ÿäº§åˆ†æ”¯ï¼Œä¸¥ç¦ç›´æ¥æäº¤
- `develop`ï¼šå¼€å‘ä¸»åˆ†æ”¯
- `feature/å§“å-åŠŸèƒ½å`ï¼šåŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼ˆå¦‚ï¼š`feature/zhangsan-student-mgmt`ï¼‰
- `hotfix/é—®é¢˜æè¿°`ï¼šç´§æ€¥ä¿®å¤åˆ†æ”¯

#### 6.2.2 Commit Message è§„èŒƒ
å¿…é¡»éµå¾ª [Conventional Commits](https://www.conventionalcommits.org/) è§„èŒƒï¼š

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type ç±»å‹**ï¼š
- `feat`ï¼šæ–°åŠŸèƒ½
- `fix`ï¼šBug ä¿®å¤
- `docs`ï¼šæ–‡æ¡£æ›´æ–°
- `refactor`ï¼šé‡æ„ï¼ˆä¸æ”¹å˜åŠŸèƒ½ï¼‰
- `test`ï¼šæµ‹è¯•ç›¸å…³
- `chore`ï¼šæ„å»º/å·¥å…·é“¾å˜æ›´

**ç¤ºä¾‹**ï¼š
```
feat(student): å¢åŠ å­¦ç”Ÿæ‰¹é‡å¯¼å…¥åŠŸèƒ½

- æ”¯æŒ Excel æ–‡ä»¶ä¸Šä¼ 
- è‡ªåŠ¨æ ¡éªŒæ•°æ®æ ¼å¼
- å¼‚æ­¥å¤„ç†å¤§æ–‡ä»¶

Closes #123
```

#### 6.2.3 Merge Request (MR) è§„èŒƒ
æäº¤ MR å¿…é¡»æ»¡è¶³ï¼š
- ä»£ç é€šè¿‡ `golangci-lint` é™æ€æ£€æŸ¥
- åŒ…å«é’ˆå¯¹è¯¥åŠŸèƒ½çš„å•å…ƒæµ‹è¯•ï¼ˆæ ¸å¿ƒé€»è¾‘æµ‹è¯•è¦†ç›–ç‡ â‰¥80%ï¼‰
- é€šè¿‡ CI/CD æµæ°´çº¿æ‰€æœ‰æ£€æŸ¥
- è‡³å°‘ä¸€åæ ¸å¿ƒæˆå‘˜ Code Review é€šè¿‡
- **è¯„å®¡æ„è§æœªä¿®æ”¹å‰ï¼Œä¸¥ç¦åˆå¹¶ä»£ç **

### 6.3 API å®šä¹‰è§„èŒƒ

#### 6.3.1 æ¥å£å…ˆè¡ŒåŸåˆ™ï¼ˆAPI Firstï¼‰
- å¿…é¡»å…ˆåœ¨ `manifests/api/` å®šä¹‰ `.api` æ–‡ä»¶
- ç»æ¶æ„å¸ˆè¯„å®¡é€šè¿‡åï¼Œä½¿ç”¨ `goctl` ç”Ÿæˆä»£ç 
- ç”Ÿæˆçš„ä»£ç ä¸­ï¼š
  - `handler` å±‚ï¼šä¸¥ç¦ä¿®æ”¹
  - `types` å±‚ï¼šä¸¥ç¦ä¿®æ”¹
  - `logic` å±‚ï¼šç¼–å†™ä¸šåŠ¡é€»è¾‘

#### 6.3.2 API å®šä¹‰ç¤ºä¾‹
```go
type StudentListRequest {
    Page     int    `form:"page,default=1"`
    PageSize int    `form:"page_size,default=20"`
    Keyword  string `form:"keyword,optional"`
}

type StudentListResponse {
    Total int64         `json:"total"`
    List  []StudentInfo `json:"list"`
}

@server(
    jwt: Auth
    middleware: SchoolInterceptor
    group: student
)
service educational-api {
    @doc "å­¦ç”Ÿåˆ—è¡¨æŸ¥è¯¢"
    @handler StudentList
    get /api/v1/students (StudentListRequest) returns (StudentListResponse)
}
```

### 6.4 ä»£ç è´¨é‡è§„èŒƒ

#### 6.4.1 é™æ€æ£€æŸ¥
- **æäº¤å‰å¿…é¡»æ‰§è¡Œ**ï¼š`golangci-lint run ./...`
- ä»£ç å¿…é¡»é€šè¿‡ `go fmt` å’Œ `goimports` å¤„ç†
- é…ç½®æ–‡ä»¶ï¼š`.golangci.yml` ç»Ÿä¸€ç»´æŠ¤

#### 6.4.2 å•å…ƒæµ‹è¯•
- **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**ï¼ˆè®¡è´¹ã€æ’è¯¾ç®—æ³•ã€æƒé™è®¡ç®—ï¼‰çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡éœ€è¾¾åˆ° **80% ä»¥ä¸Š**
- æµ‹è¯•æ–‡ä»¶å‘½åï¼š`xxx_test.go`
- ä½¿ç”¨ `testify` æ–­è¨€åº“
- å¿…é¡»åŒ…å«ï¼š
  - æ­£å¸¸æµç¨‹æµ‹è¯•
  - è¾¹ç•Œæ¡ä»¶æµ‹è¯•
  - å¼‚å¸¸åœºæ™¯æµ‹è¯•

#### 6.4.3 å‰ç«¯ä»£ç è§„èŒƒ
- **å¼€å¯ ESLint å’Œ Prettier**
- TypeScript ç¦æ­¢è¿‡åº¦ä½¿ç”¨ `any`
- ç»„ä»¶å‘½åï¼šå¤§é©¼å³°ï¼ˆPascalCaseï¼‰
- å‡½æ•°/å˜é‡å‘½åï¼šå°é©¼å³°ï¼ˆcamelCaseï¼‰

---

## 7. å¯è§‚æµ‹æ€§ä¸æ—¥å¿—è§„èŒƒ

### 7.1 é“¾è·¯è¿½è¸ªï¼ˆTracingï¼‰

#### 7.1.1 TraceID é€ä¼ 
- æ‰€æœ‰è·¨æœåŠ¡è°ƒç”¨ï¼ˆRPC/HTTPï¼‰å¿…é¡»é€ä¼  `TraceID`
- go-zero é…ç½®ä¸­å¿…é¡»å¼€å¯ Telemetryï¼š
```yaml
Telemetry:
  Name: organization-rpc
  Endpoint: http://jaeger:14268/api/traces
  Sampler: 1.0
```

#### 7.1.2 Trace é—­ç¯
- ä¸€ä¸ªè¯·æ±‚ä»å‰ç«¯åˆ°ç½‘å…³ï¼Œå†åˆ°å¤šä¸ªå¾®æœåŠ¡ï¼Œå¿…é¡»èƒ½åœ¨ **Jaeger UI** ä¸­å®Œæ•´è¿½è¸ª
- å…³é”®æ“ä½œç‚¹ï¼ˆæ•°æ®åº“æŸ¥è¯¢ã€Redis æ“ä½œã€RPC è°ƒç”¨ï¼‰å¿…é¡»è®°å½• Span

### 7.2 æ—¥å¿—è§„èŒƒ

#### 7.2.1 æ—¥å¿—åº“
- **ç¦æ­¢ä½¿ç”¨** `fmt.Printf` æˆ– `log.Println`
- å¿…é¡»ä½¿ç”¨ go-zero çš„ `logx` åŒ…
- æ—¥å¿—å¿…é¡»æºå¸¦ Context ä»¥ä¾¿è¿½è¸ª TraceID

#### 7.2.2 æ—¥å¿—çº§åˆ«
- `logx.Info`ï¼šæ­£å¸¸ä¸šåŠ¡æµç¨‹
- `logx.Error`ï¼šé”™è¯¯ã€å¼‚å¸¸æƒ…å†µ
- `logx.Slow`ï¼šæ…¢æŸ¥è¯¢ï¼ˆæ•°æ®åº“æŸ¥è¯¢è¶…è¿‡ 500msï¼‰

#### 7.2.3 æ—¥å¿—æ ¼å¼
```go
logx.WithContext(ctx).Infof("student created, school_id: %s, student_id: %s",
    schoolID, studentID)

logx.WithContext(ctx).Errorf("failed to create student: %v", err)
```

### 7.3 Go-stash æ—¥å¿—æ¸…æ´—

#### 7.3.1 æ¸…æ´—è§„åˆ™
å¼€å‘è€…éœ€è´Ÿè´£å®šä¹‰è‡ªå·±æ¨¡å—çš„æ—¥å¿—è¿‡æ»¤è§„åˆ™ï¼Œç¡®ä¿åœ¨ Kibana ä¸­èƒ½æŒ‰ `school_id` å¿«é€Ÿæ£€ç´¢æŠ¥é”™ã€‚

#### 7.3.2 æ—¥å¿—æ ‡ç­¾
æ—¥å¿—ä¸­å¿…é¡»åŒ…å«ä»¥ä¸‹æ ‡ç­¾ï¼š
- `service`ï¼šæœåŠ¡å
- `school_id`ï¼šå­¦æ ¡IDï¼ˆå¦‚æœ‰ï¼‰
- `trace_id`ï¼šé“¾è·¯è¿½è¸ªID
- `user_id`ï¼šæ“ä½œç”¨æˆ·IDï¼ˆå¦‚æœ‰ï¼‰

---

## 8. å®‰å…¨ä¸ä¿å¯†è§„èŒƒ

### 8.1 æ•æ„Ÿä¿¡æ¯ç®¡ç†

#### 8.1.1 ç¦æ­¢ç¡¬ç¼–ç 
**ä¸¥ç¦å°†ä»¥ä¸‹ä¿¡æ¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­**ï¼š
- æ•°æ®åº“å¯†ç 
- Redis å¯†ç 
- API å¯†é’¥
- JWT Secret
- ç¬¬ä¸‰æ–¹æœåŠ¡ Token

#### 8.1.2 é…ç½®ç®¡ç†
- æ•æ„Ÿé…ç½®å¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®ä¸­å¿ƒï¼ˆå¦‚ï¼šK8s ConfigMap/Secretï¼‰
- é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆ`etc/config.yaml`ï¼‰ï¼š
```yaml
DB:
  Host: ${DB_HOST}
  Port: ${DB_PORT}
  User: ${DB_USER}
  Password: ${DB_PASSWORD}
```

### 8.2 æ•°æ®å®‰å…¨

#### 8.2.1 æµ‹è¯•æ•°æ®
- **ç¦æ­¢å°†ç”Ÿäº§ç¯å¢ƒçš„çœŸå®å­¦ç”Ÿ/æ•™å¸ˆæ•°æ®ä¸‹è½½åˆ°æœ¬åœ°**
- æµ‹è¯•ä¸€å¾‹ä½¿ç”¨ Mock æ•°æ®
- æä¾› Mock æ•°æ®ç”Ÿæˆè„šæœ¬

#### 8.2.2 æ•°æ®è„±æ•
- æ—¥å¿—ä¸­ä¸å¾—è¾“å‡ºå®Œæ•´çš„æ‰‹æœºå·ã€èº«ä»½è¯å·
- å¿…é¡»è„±æ•ï¼š`138****1234`

### 8.3 ID å®‰å…¨

#### 8.3.1 UUID ä¸å¯é¢„æµ‹
- ç¦æ­¢åœ¨ URL ä¸­æš´éœ²ä»»ä½•è‡ªå¢ ID
- æ‰€æœ‰å¯¹å¤–æš´éœ²çš„ä¸šåŠ¡ ID ç»Ÿä¸€ä½¿ç”¨ UUID

#### 8.3.2 UUID æ ¡éªŒ
åç«¯åœ¨æ¥æ”¶åˆ° UUID å‚æ•°åï¼Œå¿…é¡»ç¬¬ä¸€æ—¶é—´è°ƒç”¨ `uuid.Parse()` è¿›è¡Œæ ¡éªŒï¼Œç¦æ­¢ç›´æ¥é€ä¼ è‡³æ•°æ®åº“æŸ¥è¯¢ã€‚

---

## 9. è‡ªåŠ¨åŒ–ä¸å·¥å…·é“¾

### 9.1 Makefile è§„èŒƒ

#### 9.1.1 æ ‡å‡†å‘½ä»¤
é¡¹ç›®æ ¹ç›®å½•çš„ `Makefile` å¿…é¡»æä¾›ä»¥ä¸‹å‘½ä»¤ï¼š
- `make env`ï¼šå¯åŠ¨æ‰€æœ‰ docker-compose ä¾èµ–ï¼ˆPostgreSQL, Redis, Kafka, Jaegerï¼‰
- `make gen`ï¼šè§¦å‘ goctl ç”Ÿæˆ API/RPC ä»£ç å’Œ ent generate
- `make lint`ï¼šè¿è¡Œé™æ€æ£€æŸ¥
- `make test`ï¼šè¿è¡Œå•å…ƒæµ‹è¯•
- `make build`ï¼šç¼–è¯‘æ‰€æœ‰æœåŠ¡
- `make migrate`ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

#### 9.1.2 ç¤ºä¾‹
```makefile
.PHONY: env gen lint test

env:
	docker-compose -f deploy/docker-compose/docker-compose.yaml up -d

gen:
	go generate ./data/ent
	goctl api go -api manifests/api/organization.api -dir apps/organization/api -style go_zero

lint:
	golangci-lint run ./...

test:
	go test -v -cover ./...
```

### 9.2 Docker-compose ç¯å¢ƒ

#### 9.2.1 æ ‡å‡†é…ç½®
å¼€å‘ç¯å¢ƒå¿…é¡»æä¾›ä¸€é”®å¯åŠ¨çš„ docker-compose é…ç½®ï¼ŒåŒ…å«ï¼š
- PostgreSQL 15
- Redis 7
- Kafka
- Jaeger

#### 9.2.2 ç¯å¢ƒéš”ç¦»
- å¼€å‘è€…ä»…é™è®¿é—® docker-compose å¯åŠ¨çš„æµ‹è¯•ç¯å¢ƒ
- ç”Ÿäº§ç¯å¢ƒç¯å¢ƒå˜é‡ç»Ÿä¸€ç”± CI/CD æ³¨å…¥

---

## 10. åä½œä¸æ²Ÿé€šè§„èŒƒ

### 10.1 æ¯æ—¥æŠ¥å¤‡

#### 10.1.1 æ—¥æŠ¥æ ¼å¼
æ¯æ—¥ä¸‹ç­å‰åœ¨é£ä¹¦/é’‰é’‰ç¾¤æäº¤ç®€çŸ­è¿›åº¦ï¼š
```
ã€æ—¥æŠ¥ - å§“å - 2025-01-01ã€‘
âœ… ä»Šæ—¥å®Œæˆï¼š
- å®Œæˆå­¦ç”Ÿåˆ—è¡¨ API å¼€å‘
- ç¼–å†™å­¦ç”Ÿå¯¼å…¥å•å…ƒæµ‹è¯•

ğŸ“… æ˜æ—¥è®¡åˆ’ï¼š
- å¼€å‘å­¦ç”Ÿè¯¦æƒ…é¡µé¢
- ä¼˜åŒ–å­¦ç”ŸæŸ¥è¯¢æ€§èƒ½

âŒ å­˜åœ¨é˜»å¡ï¼š
- Ent Policy é…ç½®é‡åˆ°é—®é¢˜ï¼Œéœ€è¦æ¶æ„å¸ˆååŠ©
```

### 10.2 Code Review (CR)

#### 10.2.1 CR æµç¨‹
- æ‰€æœ‰ MR å¿…é¡»ç»è¿‡è‡³å°‘ä¸€åæ ¸å¿ƒæˆå‘˜è¯„å®¡
- è¯„å®¡è€…åº”å…³æ³¨ï¼š
  - æ•°æ®è®¿é—®æƒé™é€»è¾‘æ˜¯å¦æ­£ç¡®
  - æ˜¯å¦æœ‰ SQL æ³¨å…¥é£é™©
  - æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜
  - ä»£ç é£æ ¼æ˜¯å¦ç¬¦åˆè§„èŒƒ

#### 10.2.2 CR æ—¶æ•ˆ
- æäº¤ MR åï¼Œè¯„å®¡è€…åº”åœ¨ **24 å°æ—¶å†…**å®Œæˆè¯„å®¡
- è¯„å®¡æ„è§å¿…é¡»åœ¨ **48 å°æ—¶å†…**ä¿®æ”¹å®Œæˆ

### 10.3 æ–‡æ¡£è¦æ±‚

#### 10.3.1 æœåŠ¡æ–‡æ¡£
æ¯ä¸ªæœåŠ¡éœ€åŒ…å« `README.md`ï¼Œè¯´æ˜ï¼š
- æœåŠ¡èŒè´£
- æ ¸å¿ƒ API åˆ—è¡¨
- ä¾èµ–çš„å…¶ä»–æœåŠ¡
- æœ¬åœ°å¼€å‘å¯åŠ¨æ–¹å¼

#### 10.3.2 å¤æ‚é€»è¾‘æ–‡æ¡£
å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚æ’è¯¾ç®—æ³•ã€åˆ†ç­é€»è¾‘ï¼‰å¿…é¡»åœ¨é£ä¹¦æ–‡æ¡£ä¸­ç•™å­˜ï¼Œé¿å…äººå‘˜æµåŠ¨å¯¼è‡´çš„æŠ€æœ¯å€ºã€‚

---

## 11. äº¤ä»˜ä¸éªŒæ”¶æ ‡å‡†

### 11.1 åŠŸèƒ½äº¤ä»˜æ ‡å‡†

#### 11.1.1 å¿…é¡»åŒ…å«
- åŠŸèƒ½ä»£ç ï¼ˆé€šè¿‡ CRï¼‰
- å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ â‰¥80%ï¼‰
- API æ–‡æ¡£ï¼ˆè‡ªåŠ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨è¡¥å……ï¼‰
- åŸºæœ¬çš„é›†æˆæµ‹è¯•

#### 11.1.2 éªŒæ”¶æµç¨‹
1. æäº¤ MRï¼Œé€šè¿‡ CI/CD è‡ªåŠ¨æ£€æŸ¥
2. æ ¸å¿ƒæˆå‘˜ Code Review
3. åœ¨æµ‹è¯•ç¯å¢ƒéƒ¨ç½²éªŒè¯
4. äº§å“/é¡¹ç›®ç»ç†åŠŸèƒ½éªŒæ”¶
5. åˆå¹¶åˆ° develop åˆ†æ”¯

### 11.2 æ€§èƒ½æ ‡å‡†

#### 11.2.1 å“åº”æ—¶é—´

**ç®€å•æŸ¥è¯¢æ¥å£**ï¼ˆå•è¡¨æŸ¥è¯¢ï¼Œæ— å¤æ‚è®¡ç®—ï¼‰ï¼š
- è¯¦æƒ…æŸ¥è¯¢æ¥å£ï¼šâ‰¤ 100msï¼ˆP95ï¼‰
- ç®€å•åˆ—è¡¨æŸ¥è¯¢ï¼ˆå¦‚ï¼šå­¦ç”Ÿåˆ—è¡¨ã€æ•™å¸ˆåˆ—è¡¨ï¼‰ï¼šâ‰¤ 200msï¼ˆP95ï¼‰
- æ•°æ®å†™å…¥æ¥å£ï¼ˆå•è¡¨ CRUDï¼‰ï¼šâ‰¤ 300msï¼ˆP95ï¼‰

**å¤æ‚æŸ¥è¯¢æ¥å£**ï¼ˆå¤šè¡¨å…³è”ã€èšåˆç»Ÿè®¡ã€æŠ¥è¡¨ç”Ÿæˆï¼‰ï¼š
- ç»Ÿè®¡æŠ¥è¡¨æ¥å£ï¼ˆå¦‚ï¼šå­¦æœŸæˆç»©æ±‡æ€»ï¼‰ï¼šâ‰¤ 1000msï¼ˆP95ï¼‰
- å¤æ‚åˆ—è¡¨æŸ¥è¯¢ï¼ˆå¤šè¡¨ JOINã€å­æŸ¥è¯¢ï¼‰ï¼šâ‰¤ 500msï¼ˆP95ï¼‰
- æ‰¹é‡å¯¼å…¥/å¯¼å‡ºæ¥å£ï¼šâ‰¤ 2000msï¼ˆP95ï¼‰æˆ–é‡‡ç”¨å¼‚æ­¥å¤„ç†

**ä¼˜åŒ–è¦æ±‚**ï¼š
- æ‰€æœ‰æ¥å£å¿…é¡»æ·»åŠ **åˆç†çš„ç´¢å¼•**ï¼ˆEnt Index å®šä¹‰ï¼‰
- åˆ—è¡¨æŸ¥è¯¢å¿…é¡»æ”¯æŒ**åˆ†é¡µ**ï¼Œå•é¡µæ•°æ®é‡å»ºè®® â‰¤ 100 æ¡
- å¤æ‚æŠ¥è¡¨ä¼˜å…ˆè€ƒè™‘**å¼‚æ­¥ä»»åŠ¡** + **ç»“æœç¼“å­˜**ï¼ˆRedisï¼ŒTTL 5-30åˆ†é’Ÿï¼‰
- ä½¿ç”¨ Jaeger é“¾è·¯è¿½è¸ªå®šä½æ…¢æŸ¥è¯¢ï¼Œä¼˜åŒ– SQL æ‰§è¡Œè®¡åˆ’

#### 11.2.2 å¹¶å‘èƒ½åŠ›
- å•æœåŠ¡æ”¯æŒ â‰¥ 1000 QPSï¼ˆå¸¸è§„ä¸šåŠ¡æ¥å£ï¼‰
- æ•°æ®åº“è¿æ¥æ± é…ç½®åˆç†ï¼Œé¿å…è¿æ¥æ³„æ¼

### 11.3 ä¸åˆæ ¼äº¤ä»˜

ä»¥ä¸‹æƒ…å†µè§†ä¸ºä¸åˆæ ¼äº¤ä»˜ï¼Œä¸äºˆéªŒæ”¶ç»“ç®—ï¼š
- å­˜åœ¨æ•°æ®è®¿é—®æƒé™é—®é¢˜ï¼ˆæœªç»æˆæƒè·¨æ ¡æŸ¥è¯¢æ•°æ®ï¼‰
- å­˜åœ¨ SQL æ³¨å…¥ã€XSS ç­‰å®‰å…¨æ¼æ´
- ä»£ç æœªé€šè¿‡é™æ€æ£€æŸ¥
- ç¼ºå°‘å•å…ƒæµ‹è¯•æˆ–æµ‹è¯•è¦†ç›–ç‡ä¸è¾¾æ ‡
- ç ´åç°æœ‰åŠŸèƒ½ï¼ˆå›å½’æµ‹è¯•å¤±è´¥ï¼‰
- æœªéµå¾ª Commit Message è§„èŒƒ
- ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯

---

## 12. é™„å½•

### 12.1 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# å¯åŠ¨å¼€å‘ç¯å¢ƒ
make env

# ç”Ÿæˆä»£ç 
make gen

# è¿è¡Œé™æ€æ£€æŸ¥
make lint

# è¿è¡Œæµ‹è¯•
make test

# æŸ¥çœ‹ Jaeger é“¾è·¯è¿½è¸ª
open http://localhost:16686

# æŸ¥çœ‹ Kafka æ¶ˆæ¯
docker-compose exec kafka kafka-console-consumer --bootstrap-server localhost:9092 --topic xxx
```

### 12.2 å¸¸è§é—®é¢˜ FAQ

#### Q1: å¦‚ä½•åœ¨æœ¬åœ°è°ƒè¯•å¤šå­¦æ ¡æ•°æ®è®¿é—®ï¼Ÿ
A: åœ¨è¯·æ±‚å¤´ä¸­æ‰‹åŠ¨è®¾ç½® `X-View-Scope`ï¼Œå¹¶åœ¨ JWT ä¸­æ¨¡æ‹Ÿä¸åŒçš„ç”¨æˆ·èº«ä»½ã€‚

#### Q2: å¦‚ä½•å¤„ç†å¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆå¦‚å­¦ç”Ÿæ‰¹é‡å¯¼å…¥ï¼‰ï¼Ÿ
A: ä½¿ç”¨ Asynq å¼‚æ­¥ä»»åŠ¡ï¼Œå‰ç«¯è½®è¯¢ä»»åŠ¡çŠ¶æ€ã€‚

#### Q3: å¦‚ä½•æ’æŸ¥æ…¢æŸ¥è¯¢ï¼Ÿ
A: æŸ¥çœ‹ Jaeger é“¾è·¯è¿½è¸ªï¼Œå®šä½è€—æ—¶çš„æ•°æ®åº“æ“ä½œï¼Œä¼˜åŒ–ç´¢å¼•æˆ–æŸ¥è¯¢è¯­å¥ã€‚

---

## 13. åè®®å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å˜æ›´äºº |
|------|------|---------|--------|
| V1.0 | 2024-09-12 | åˆå§‹ç‰ˆæœ¬ | Lasko |
| V1.1 | 2025-03-19 | å¢åŠ  UUID è§„èŒƒã€å±‚çº§ç»„ç»‡æ ‘è§„èŒƒã€å®¡è®¡æ—¥å¿—è§„èŒƒ | Chh |
| V1.2 | 2025-12-27 | fork ä¿®æ”¹ä¸ºæ•™è‚²ç³»ç»Ÿå¼€å‘æ–‡æ¡£ | Enkh |

---
