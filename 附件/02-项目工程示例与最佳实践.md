# é¡¹ç›®å·¥ç¨‹ç¤ºä¾‹ä¸æœ€ä½³å®è·µ

## æ–‡æ¡£è¯´æ˜
2025.12.27 ä¿®æ”¹ç‰ˆï¼šæä¾›é›†å›¢åŒ–æ•™è‚²ç®¡ç†ç³»ç»Ÿçš„æ ¸å¿ƒä»£ç ç¤ºä¾‹ã€é…ç½®æ¨¡æ¿å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹å¹¶éµå¾ªç»Ÿä¸€æ ‡å‡†ã€‚

---

## 1. å¼€å‘ç¯å¢ƒé…ç½®

### 1.1 Docker-compose é…ç½®

**æ–‡ä»¶è·¯å¾„**ï¼š`deploy/docker-compose/docker-compose.yaml`

```yaml
version: '3.8'

services:
  # æ ¸å¿ƒæ•°æ®åº“ï¼šPostgreSQL 15
  postgres:
    image: postgres:15-alpine
    container_name: edu_postgres
    environment:
      POSTGRES_USER: edu_user
      POSTGRES_PASSWORD: edu_password
      POSTGRES_DB: edu_system
      # è®¾ç½®æ—¶åŒº
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # è‡ªå®šä¹‰é…ç½®
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    networks:
      - edu_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U edu_user -d edu_system"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ç¼“å­˜ä¸é˜Ÿåˆ—ï¼šRedis 7
  redis:
    image: redis:7-alpine
    container_name: edu_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --requirepass redis_password
    networks:
      - edu_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # é“¾è·¯è¿½è¸ªï¼šJaeger
  jaeger:
    image: jaegertracing/all-in-one:1.51
    container_name: edu_jaeger
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
    ports:
      - "5775:5775/udp"   # Agent
      - "6831:6831/udp"   # Agent
      - "6832:6832/udp"   # Agent
      - "5778:5778"       # Agent
      - "16686:16686"     # UI
      - "14268:14268"     # Collector
      - "14250:14250"     # Collector
      - "9411:9411"       # Zipkin
    networks:
      - edu_network

  # æ¶ˆæ¯æµï¼šKafka (ä½¿ç”¨ KRaft æ¨¡å¼)
  kafka:
    image: bitnami/kafka:3.6
    container_name: edu_kafka
    environment:
      # KRaft settings
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      # Listeners
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      # Cluster settings
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_CFG_LOG_RETENTION_HOURS=168
    ports:
      - "9092:9092"
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      - edu_network
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Kafka UI (å¯é€‰ï¼Œæ–¹ä¾¿è°ƒè¯•)
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: edu_kafka_ui
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    ports:
      - "8080:8080"
    depends_on:
      - kafka
    networks:
      - edu_network

  # Elasticsearch (æ—¥å¿—å­˜å‚¨)
  elasticsearch:
    image: elasticsearch:8.11.1
    container_name: edu_elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - edu_network

  # Kibana (æ—¥å¿—æŸ¥è¯¢UI)
  kibana:
    image: kibana:8.11.1
    container_name: edu_kibana
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - edu_network

volumes:
  postgres_data:
  redis_data:
  kafka_data:
  es_data:

networks:
  edu_network:
    driver: bridge
```

### 1.2 PostgreSQL ä¼˜åŒ–é…ç½®

**æ–‡ä»¶è·¯å¾„**ï¼š`deploy/docker-compose/postgres/postgresql.conf`

```conf
# è¿æ¥è®¾ç½®
max_connections = 200
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 2MB
min_wal_size = 1GB
max_wal_size = 4GB

# æ—¥å¿—è®¾ç½®
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_statement = 'mod'
log_duration = off
log_min_duration_statement = 500  # è®°å½•æ…¢æŸ¥è¯¢ï¼ˆè¶…è¿‡500msï¼‰

# UUID æ‰©å±•
shared_preload_libraries = 'uuid-ossp'
```

### 1.3 ä¸€é”®å¯åŠ¨è„šæœ¬

**æ–‡ä»¶è·¯å¾„**ï¼š`scripts/dev-env.sh`

```bash
#!/bin/bash

set -e

echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."

# æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œ
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨ Docker"
    exit 1
fi

# å¯åŠ¨ docker-compose
cd deploy/docker-compose
docker-compose up -d

echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 10

# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
docker-compose ps

echo ""
echo "âœ… å¼€å‘ç¯å¢ƒå¯åŠ¨æˆåŠŸï¼"
echo ""
echo "ğŸ“Š æœåŠ¡è®¿é—®åœ°å€ï¼š"
echo "  - PostgreSQL: localhost:5432"
echo "  - Redis: localhost:6379"
echo "  - Kafka: localhost:9092"
echo "  - Kafka UI: http://localhost:8080"
echo "  - Jaeger UI: http://localhost:16686"
echo "  - Kibana: http://localhost:5601"
echo ""
echo "ğŸ“– æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š"
echo "  - Host: localhost"
echo "  - Port: 5432"
echo "  - User: edu_user"
echo "  - Password: edu_password"
echo "  - Database: edu_system"
echo ""
```

---

## 2. Ent Schema ç¤ºä¾‹

### 2.1 SchoolMixinï¼ˆå­¦æ ¡å…³è”æ··å…¥ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`data/schema/school_mixin.go`

```go
package schema

import (
	"context"

	"entgo.io/ent"
	"entgo.io/ent/schema/field"
	"entgo.io/ent/schema/mixin"
	"github.com/google/uuid"
)

// SchoolMixin è‡ªåŠ¨ä¸ºæ‰€æœ‰è¡¨æ³¨å…¥å­¦æ ¡ ID
// school_id å…³è”organizationè¡¨ä¸­type='SCHOOL'çš„è®°å½•
type SchoolMixin struct {
	mixin.Schema
}

// Fields å®šä¹‰å­¦æ ¡å­—æ®µ
func (SchoolMixin) Fields() []ent.Field {
	return []ent.Field{
		field.UUID("school_id", uuid.UUID{}).
			Comment("å­¦æ ¡IDï¼Œå¤–é”®å…³è”organizationè¡¨").
			Immutable(). // å†™å…¥åä¸å¯ä¿®æ”¹
			NotEmpty(),
	}
}

// Indexes å®šä¹‰ç´¢å¼•
func (SchoolMixin) Indexes() []ent.Index {
	return []ent.Index{
		index.Fields("school_id"),
	}
}

// Hooks å®šä¹‰é’©å­ï¼ˆå¯é€‰ï¼šè‡ªåŠ¨éªŒè¯å­¦æ ¡IDï¼‰
func (SchoolMixin) Hooks() []ent.Hook {
	return []ent.Hook{
		// ç¡®ä¿åˆ›å»ºæ—¶å¿…é¡»æä¾› school_id
		func(next ent.Mutator) ent.Mutator {
			return ent.MutateFunc(func(ctx context.Context, m ent.Mutation) (ent.Value, error) {
				if m.Op().Is(ent.OpCreate) {
					schoolID, exists := m.Field("school_id")
					if !exists || schoolID == uuid.Nil {
						return nil, fmt.Errorf("school_id is required and cannot be nil")
					}
				}
				return next.Mutate(ctx, m)
			})
		},
	}
}
```

### 2.2 Organization Schemaï¼ˆç»„ç»‡æ¶æ„ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`data/schema/organization.go`

```go
package schema

import (
	"entgo.io/ent"
	"entgo.io/ent/schema/edge"
	"entgo.io/ent/schema/field"
	"entgo.io/ent/schema/index"
	"github.com/google/uuid"
)

// Organization ç»„ç»‡æ¶æ„è¡¨
type Organization struct {
	ent.Schema
}

// Fields å®šä¹‰å­—æ®µ
func (Organization) Fields() []ent.Field {
	return []ent.Field{
		field.UUID("id", uuid.UUID{}).
			Default(uuid.New).
			Unique().
			Immutable(),

		field.String("name").
			NotEmpty().
			Comment("ç»„ç»‡åç§°"),

		field.Enum("type").
			Values("GROUP", "SCHOOL", "CAMPUS", "DEPARTMENT", "CLASS").
			Comment("ç»„ç»‡ç±»å‹"),

		field.UUID("parent_id", uuid.UUID{}).
			Optional().
			Nillable().
			Comment("çˆ¶çº§ç»„ç»‡ID"),

		field.String("path").
			Optional().
			Comment("å±‚çº§è·¯å¾„ï¼Œå¦‚: root_uuid.school_uuid.dept_uuid"),

		field.UUID("group_id", uuid.UUID{}).
			Comment("æ‰€å±é›†å›¢IDï¼ˆå†—ä½™å­—æ®µï¼Œæ–¹ä¾¿é›†å›¢æŸ¥è¯¢ï¼‰"),

		field.Int("sort_order").
			Default(0).
			Comment("æ’åºåºå·"),

		field.Bool("is_active").
			Default(true).
			Comment("æ˜¯å¦å¯ç”¨"),

		field.Time("created_at").
			Immutable().
			Default(time.Now),

		field.Time("updated_at").
			Default(time.Now).
			UpdateDefault(time.Now),
	}
}

// Edges å®šä¹‰å…³ç³»
func (Organization) Edges() []ent.Edge {
	return []ent.Edge{
		// è‡ªå¼•ç”¨ï¼šçˆ¶å­å…³ç³»
		edge.To("children", Organization.Type).
			From("parent").
			Field("parent_id").
			Unique(),

		// å…³è”ç”¨æˆ·
		edge.To("users", User.Type),
	}
}

// Indexes å®šä¹‰ç´¢å¼•
func (Organization) Indexes() []ent.Index {
	return []ent.Index{
		index.Fields("parent_id"),
		index.Fields("path"),
		index.Fields("group_id"),
		index.Fields("type"),
	}
}

// Hooks å®šä¹‰é’©å­ï¼ˆè‡ªåŠ¨ç»´æŠ¤ path å­—æ®µï¼‰
func (Organization) Hooks() []ent.Hook {
	return []ent.Hook{
		// åˆ›å»ºæ—¶è‡ªåŠ¨ç”Ÿæˆ path
		func(next ent.Mutator) ent.Mutator {
			return hook.OrganizationFunc(func(ctx context.Context, m *ent.OrganizationMutation) (ent.Value, error) {
				if m.Op().Is(ent.OpCreate) {
					parentID, exists := m.ParentID()
					if exists && parentID != uuid.Nil {
						// æŸ¥è¯¢çˆ¶èŠ‚ç‚¹çš„ path
						parent, err := m.Client().Organization.Get(ctx, parentID)
						if err != nil {
							return nil, err
						}
						// ç”Ÿæˆæ–° path
						id, _ := m.ID()
						newPath := fmt.Sprintf("%s.%s", parent.Path, id.String())
						m.SetPath(newPath)
					} else {
						// æ ¹èŠ‚ç‚¹
						id, _ := m.ID()
						m.SetPath(id.String())
					}
				}
				return next.Mutate(ctx, m)
			})
		},
	}
}
```

### 2.3 Student Schemaï¼ˆå­¦ç”Ÿï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`data/schema/student.go`

```go
package schema

import (
	"entgo.io/ent"
	"entgo.io/ent/schema/edge"
	"entgo.io/ent/schema/field"
	"entgo.io/ent/schema/index"
	"entgo.io/ent/schema/mixin"
	"github.com/google/uuid"
)

// Student å­¦ç”Ÿè¡¨
type Student struct {
	ent.Schema
}

// Mixin æ··å…¥é€šç”¨å­—æ®µ
func (Student) Mixin() []ent.Mixin {
	return []ent.Mixin{
		SchoolMixin{}, // å­¦æ ¡å…³è”
		TimeMixin{},   // æ—¶é—´å­—æ®µ
	}
}

// Fields å®šä¹‰å­—æ®µ
func (Student) Fields() []ent.Field {
	return []ent.Field{
		field.UUID("id", uuid.UUID{}).
			Default(uuid.New).
			Unique().
			Immutable(),

		field.String("student_no").
			NotEmpty().
			Comment("å­¦å·"),

		field.String("name").
			NotEmpty().
			Comment("å§“å"),

		field.Enum("gender").
			Values("MALE", "FEMALE").
			Comment("æ€§åˆ«"),

		field.Time("birth_date").
			Optional().
			Comment("å‡ºç”Ÿæ—¥æœŸ"),

		field.String("id_card").
			Optional().
			Comment("èº«ä»½è¯å·"),

		field.String("phone").
			Optional().
			Comment("è”ç³»ç”µè¯"),

		field.UUID("class_id", uuid.UUID{}).
			Optional().
			Nillable().
			Comment("æ‰€å±ç­çº§ID"),

		field.Enum("status").
			Values("ACTIVE", "GRADUATED", "TRANSFERRED", "DROPOUT").
			Default("ACTIVE").
			Comment("å­¦ç±çŠ¶æ€"),
	}
}

// Edges å®šä¹‰å…³ç³»
func (Student) Edges() []ent.Edge {
	return []ent.Edge{
		// æ‰€å±ç­çº§
		edge.To("class", Organization.Type).
			Field("class_id").
			Unique(),

		// æˆç»©è®°å½•
		edge.To("grades", Grade.Type),
	}
}

// Indexes å®šä¹‰ç´¢å¼•
func (Student) Indexes() []ent.Index {
	return []ent.Index{
		// å¤åˆç´¢å¼•ï¼šschool_id + student_noï¼ˆå”¯ä¸€ï¼‰
		index.Fields("school_id", "student_no").Unique(),

		// å¤åˆç´¢å¼•ï¼šschool_id + class_id
		index.Fields("school_id", "class_id"),

		// å¤åˆç´¢å¼•ï¼šschool_id + status
		index.Fields("school_id", "status"),
	}
}
```

### 2.4 Permission Schemaï¼ˆæƒé™è¡¨ - å…¨å±€å…±äº«ï¼‰

**è®¾è®¡è¯´æ˜**ï¼šPermission è¡¨é‡‡ç”¨**å…¨å±€å…±äº«**è®¾è®¡ï¼Œä¸ä½¿ç”¨ SchoolMixinã€‚é›†å›¢å±‚é¢ç»Ÿä¸€å®šä¹‰ç³»ç»Ÿæƒé™ï¼Œæ‰€æœ‰å­¦æ ¡å…±äº«ç›¸åŒçš„æƒé™å®šä¹‰ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`data/schema/permission.go`

```go
package schema

import (
	"time"

	"entgo.io/ent"
	"entgo.io/ent/schema/edge"
	"entgo.io/ent/schema/field"
	"entgo.io/ent/schema/index"
	"github.com/google/uuid"
)

// Permission æƒé™è¡¨ï¼ˆå…¨å±€å…±äº«ï¼Œä¸éœ€è¦å­¦æ ¡çº§å…³è”ï¼‰
type Permission struct {
	ent.Schema
}

// æ³¨æ„ï¼šPermission ä¸ä½¿ç”¨ SchoolMixinï¼Œä¸ºå…¨å±€å…±äº«è¡¨
func (Permission) Fields() []ent.Field {
	return []ent.Field{
		field.UUID("id", uuid.UUID{}).
			Default(uuid.New).
			Unique().
			Immutable(),

		field.String("resource").
			NotEmpty().
			Comment("èµ„æºç±»å‹ï¼Œå¦‚ï¼šstudentã€teacherã€grade"),

		field.String("action").
			NotEmpty().
			Comment("æ“ä½œï¼Œå¦‚ï¼šcreateã€readã€updateã€deleteã€export"),

		field.String("description").
			Optional().
			Comment("æƒé™æè¿°"),

		field.String("resource_filter").
			Optional().
			Comment("èµ„æºè¿‡æ»¤æ¡ä»¶ï¼ŒJSONæ ¼å¼ï¼Œç”¨äºABAC"),

		field.Time("created_at").
			Immutable().
			Default(time.Now).
			Comment("åˆ›å»ºæ—¶é—´"),

		field.Time("updated_at").
			Default(time.Now).
			UpdateDefault(time.Now).
			Comment("æ›´æ–°æ—¶é—´"),
	}
}

// Edges å®šä¹‰å…³ç³»
func (Permission) Edges() []ent.Edge {
	return []ent.Edge{
		edge.From("roles", Role.Type).
			Ref("permissions"),
	}
}

// Indexes å®šä¹‰ç´¢å¼•
func (Permission) Indexes() []ent.Index {
	return []ent.Index{
		// å¤åˆå”¯ä¸€ç´¢å¼•ï¼šé˜²æ­¢é‡å¤å®šä¹‰åŒä¸€æƒé™
		index.Fields("resource", "action").Unique(),
	}
}
```

### 2.5 Role Schemaï¼ˆè§’è‰²è¡¨ - å­¦æ ¡å…³è”ï¼‰

**è®¾è®¡è¯´æ˜**ï¼šRole è¡¨é‡‡ç”¨å­¦æ ¡å…³è”è®¾è®¡ï¼Œæ¯ä¸ªå­¦æ ¡å¯åˆ›å»ºè‡ªå·±çš„è§’è‰²ã€‚é›†å›¢è§’è‰²ä½¿ç”¨ `school_id = uuid.Nil` ä½œä¸ºç‰¹æ®Šæ ‡è¯†ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`data/schema/role.go`

```go
package schema

import (
	"entgo.io/ent"
	"entgo.io/ent/schema/edge"
	"entgo.io/ent/schema/field"
	"entgo.io/ent/schema/index"
	"entgo.io/ent/schema/mixin"
	"github.com/google/uuid"
)

// Role è§’è‰²è¡¨
type Role struct {
	ent.Schema
}

// Mixin æ··å…¥é€šç”¨å­—æ®µ
func (Role) Mixin() []ent.Mixin {
	return []ent.Mixin{
		SchoolMixin{}, // å­¦æ ¡å…³è”
		TimeMixin{},   // æ—¶é—´å­—æ®µ
	}
}

// Fields å®šä¹‰å­—æ®µ
func (Role) Fields() []ent.Field {
	return []ent.Field{
		field.UUID("id", uuid.UUID{}).
			Default(uuid.New).
			Unique().
			Immutable(),

		field.String("name").
			NotEmpty().
			Comment("è§’è‰²åç§°ï¼Œå¦‚ï¼šæ ¡é•¿ã€ç­ä¸»ä»»ã€æ•™å¸ˆ"),

		field.String("code").
			NotEmpty().
			Comment("è§’è‰²ä»£ç ï¼Œå¦‚ï¼šprincipalã€teacher"),

		field.String("description").
			Optional().
			Comment("è§’è‰²æè¿°"),

		field.Enum("type").
			Values("SYSTEM", "CUSTOM").
			Default("CUSTOM").
			Comment("è§’è‰²ç±»å‹ï¼šSYSTEM-ç³»ç»Ÿé¢„å®šä¹‰ï¼ŒCUSTOM-ç”¨æˆ·è‡ªå®šä¹‰"),

		field.Bool("is_active").
			Default(true).
			Comment("æ˜¯å¦å¯ç”¨"),
	}
}

// Edges å®šä¹‰å…³ç³»
func (Role) Edges() []ent.Edge {
	return []ent.Edge{
		edge.To("permissions", Permission.Type).
			Comment("è§’è‰²æ‹¥æœ‰çš„æƒé™"),

		edge.From("user_roles", UserRole.Type).
			Ref("role").
			Comment("ä½¿ç”¨è¯¥è§’è‰²çš„ç”¨æˆ·"),
	}
}

// Indexes å®šä¹‰ç´¢å¼•
func (Role) Indexes() []ent.Index {
	return []ent.Index{
		// å¤åˆå”¯ä¸€ç´¢å¼•ï¼šåŒä¸€å­¦æ ¡å†…è§’è‰²ä»£ç å”¯ä¸€
		index.Fields("school_id", "code").Unique(),
		// æ™®é€šç´¢å¼•ï¼šæŒ‰å­¦æ ¡æŸ¥è¯¢
		index.Fields("school_id", "is_active"),
	}
}
```

### 2.6 UserRole Schemaï¼ˆç”¨æˆ·è§’è‰²å…³è”è¡¨ - å­¦æ ¡å…³è”ï¼‰

**è®¾è®¡è¯´æ˜**ï¼šUserRole è¡¨å…³è”ç”¨æˆ·å’Œè§’è‰²ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´å’Œä½œç”¨åŸŸé™åˆ¶ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`data/schema/user_role.go`

```go
package schema

import (
	"time"

	"entgo.io/ent"
	"entgo.io/ent/schema/edge"
	"entgo.io/ent/schema/field"
	"entgo.io/ent/schema/index"
	"entgo.io/ent/schema/mixin"
	"github.com/google/uuid"
)

// UserRole ç”¨æˆ·è§’è‰²å…³è”è¡¨
type UserRole struct {
	ent.Schema
}

// Mixin æ··å…¥é€šç”¨å­—æ®µ
func (UserRole) Mixin() []ent.Mixin {
	return []ent.Mixin{
		SchoolMixin{}, // å­¦æ ¡å…³è”
		TimeMixin{},   // æ—¶é—´å­—æ®µ
	}
}

// Fields å®šä¹‰å­—æ®µ
func (UserRole) Fields() []ent.Field {
	return []ent.Field{
		field.UUID("id", uuid.UUID{}).
			Default(uuid.New).
			Unique().
			Immutable(),

		field.UUID("user_id", uuid.UUID{}).
			NotEmpty().
			Comment("ç”¨æˆ·ID"),

		field.UUID("role_id", uuid.UUID{}).
			NotEmpty().
			Comment("è§’è‰²ID"),

		field.UUID("scope_org_id", uuid.UUID{}).
			Optional().
			Nillable().
			Comment("æƒé™ä½œç”¨åŸŸï¼ˆå¦‚ç­çº§IDï¼‰ï¼Œä¸ºç©ºè¡¨ç¤ºå…¨å±€æƒé™"),

		field.Time("effective_from").
			Optional().
			Nillable().
			Comment("ç”Ÿæ•ˆå¼€å§‹æ—¶é—´"),

		field.Time("effective_to").
			Optional().
			Nillable().
			Comment("ç”Ÿæ•ˆç»“æŸæ—¶é—´"),
	}
}

// Edges å®šä¹‰å…³ç³»
func (UserRole) Edges() []ent.Edge {
	return []ent.Edge{
		edge.To("role", Role.Type).
			Required().
			Unique().
			Field("role_id"),
	}
}

// Indexes å®šä¹‰ç´¢å¼•
func (UserRole) Indexes() []ent.Index {
	return []ent.Index{
		// è”åˆå”¯ä¸€ç´¢å¼•ï¼šé˜²æ­¢åŒä¸€ç”¨æˆ·åœ¨åŒä¸€å­¦æ ¡ä¸‹è¢«é‡å¤åˆ†é…åŒä¸€è§’è‰²
		index.Fields("school_id", "user_id", "role_id").Unique(),

		// æ™®é€šç´¢å¼•ï¼šåŠ é€ŸæŸ¥è¯¢
		index.Fields("user_id"),
		index.Fields("role_id"),
	}
}
```

### 2.7 TimeMixinï¼ˆæ—¶é—´å­—æ®µæ··å…¥ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`data/schema/time_mixin.go`

```go
package schema

import (
	"time"

	"entgo.io/ent"
	"entgo.io/ent/schema/field"
	"entgo.io/ent/schema/mixin"
)

// TimeMixin æ—¶é—´å­—æ®µæ··å…¥
type TimeMixin struct {
	mixin.Schema
}

// Fields å®šä¹‰æ—¶é—´å­—æ®µ
func (TimeMixin) Fields() []ent.Field {
	return []ent.Field{
		field.Time("created_at").
			Immutable().
			Default(time.Now).
			Comment("åˆ›å»ºæ—¶é—´"),

		field.Time("updated_at").
			Default(time.Now).
			UpdateDefault(time.Now).
			Comment("æ›´æ–°æ—¶é—´"),

		field.Time("deleted_at").
			Optional().
			Nillable().
			Comment("è½¯åˆ é™¤æ—¶é—´"),
	}
}
```

---

## 3. go-zero ä¸­é—´ä»¶ç¤ºä¾‹

### 3.1 å­¦æ ¡æ‹¦æˆªå™¨

**æ–‡ä»¶è·¯å¾„**ï¼š`core/middleware/school_middleware.go`

```go
package middleware

import (
	"context"
	"net/http"

	"github.com/google/uuid"
	"github.com/zeromicro/go-zero/core/logx"
	"github.com/zeromicro/go-zero/rest/httpx"
)

// SchoolInterceptor å­¦æ ¡å…³è”ä¸­é—´ä»¶
func SchoolInterceptor(next http.HandlerFunc) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		// 1. ä» JWT è§£æå‡ºç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆå‡è®¾å·²åœ¨ Auth ä¸­é—´ä»¶å¤„ç†ï¼‰
		userOrgID, ok := ctx.Value("user_org_id").(string)
		if !ok || userOrgID == "" {
			httpx.Error(w, &httpx.CodeError{
				Code: http.StatusUnauthorized,
				Msg:  "missing user organization info",
			})
			return
		}

		userType, ok := ctx.Value("user_type").(string)
		if !ok || userType == "" {
			httpx.Error(w, &httpx.CodeError{
				Code: http.StatusUnauthorized,
				Msg:  "missing user type info",
			})
			return
		}

		// 2. è·å–è·¨æ ¡æŸ¥çœ‹èŒƒå›´ X-View-Scope
		viewScope := r.Header.Get("X-View-Scope")

		var targetSchoolID uuid.UUID
		var err error

		if userType == "GROUP" {
			// é›†å›¢ç”¨æˆ·
			if viewScope == "all" || viewScope == "" {
				// å…¨å±€æ¨¡å¼ï¼šæŸ¥çœ‹æ‰€æœ‰å­¦æ ¡
				targetSchoolID = uuid.Nil
				logx.WithContext(ctx).Infof("group user access in global mode, user_org_id: %s", userOrgID)
			} else {
				// ä»£ç®¡æ¨¡å¼ï¼šæŸ¥çœ‹ç‰¹å®šå­¦æ ¡
				targetSchoolID, err = uuid.Parse(viewScope)
				if err != nil {
					httpx.Error(w, &httpx.CodeError{
						Code: http.StatusBadRequest,
						Msg:  "invalid X-View-Scope UUID format",
					})
					return
				}

				// TODO: æ ¡éªŒè¯¥é›†å›¢ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®æ­¤ targetSchoolID
				// å¯é€šè¿‡æŸ¥è¯¢ organization è¡¨çš„ path å­—æ®µéªŒè¯

				logx.WithContext(ctx).Infof("group user access school, user_org_id: %s, target_school_id: %s",
					userOrgID, targetSchoolID)

				// è®°å½•å®¡è®¡æ—¥å¿—
				go recordAuditLog(ctx, userOrgID, targetSchoolID.String(), r.URL.Path)
			}
		} else {
			// å­¦æ ¡ç”¨æˆ·ï¼šå¼ºåˆ¶é”å®šæœ¬æ ¡ ID
			targetSchoolID, err = uuid.Parse(userOrgID)
			if err != nil {
				httpx.Error(w, &httpx.CodeError{
					Code: http.StatusInternalServerError,
					Msg:  "invalid user organization UUID",
				})
				return
			}

			logx.WithContext(ctx).Infof("school user access, school_id: %s", targetSchoolID)
		}

		// 3. å°†æœ€ç»ˆç¡®å®šçš„ SchoolID æ³¨å…¥ Context ä¾› Ent ä½¿ç”¨
		// school_id åœ¨å½“å‰ä¸šåŠ¡ä¸­ä»£è¡¨å­¦æ ¡ID
		ctx = context.WithValue(ctx, "school_id", targetSchoolID)
		ctx = context.WithValue(ctx, "user_type", userType)

		next(w, r.WithContext(ctx))
	}
}

// recordAuditLog è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆå¼‚æ­¥ï¼‰
func recordAuditLog(ctx context.Context, operatorID, targetSchoolID, resource string) {
	// TODO: å®ç°å®¡è®¡æ—¥å¿—è®°å½•é€»è¾‘
	// å¯å†™å…¥æ•°æ®åº“æˆ–å‘é€åˆ° Kafka
	logx.WithContext(ctx).Infof("audit log: operator=%s, target=%s, resource=%s",
		operatorID, targetSchoolID, resource)
}
```

### 3.2 Ent Privacy Policy ç¤ºä¾‹

**æ–‡ä»¶è·¯å¾„**ï¼š`data/privacy/school_policy.go`

```go
package privacy

import (
	"context"

	"entgo.io/ent/privacy"
	"github.com/google/uuid"
)

// SchoolQueryRule å­¦æ ¡æŸ¥è¯¢è§„åˆ™
func SchoolQueryRule() privacy.QueryRule {
	return privacy.QueryRuleFunc(func(ctx context.Context, q ent.Query) error {
		// ä» Context è·å– school_id
		schoolID, ok := ctx.Value("school_id").(uuid.UUID)
		if !ok {
			return privacy.Denyf("missing school_id in context")
		}

		// å¦‚æœæ˜¯é›†å›¢å…¨å±€æ¨¡å¼ï¼ˆschool_id ä¸º uuid.Nilï¼‰ï¼Œå…è®¸æŸ¥çœ‹æ‰€æœ‰
		if schoolID == uuid.Nil {
			userType, _ := ctx.Value("user_type").(string)
			if userType == "GROUP" {
				return privacy.Skip
			}
			return privacy.Denyf("non-group user cannot access global data")
		}

		// å­¦æ ¡æ¨¡å¼ï¼šè‡ªåŠ¨æ³¨å…¥ WHERE school_id = xxx
		// è¿™é‡Œéœ€è¦æ ¹æ®å…·ä½“çš„ Ent ç”Ÿæˆä»£ç è°ƒæ•´
		// ç¤ºä¾‹ï¼šå‡è®¾ q æ˜¯ StudentQuery
		if sq, ok := q.(*ent.StudentQuery); ok {
			sq.Where(student.SchoolIDEQ(schoolID))
		}

		return privacy.Skip
	})
}

// SchoolMutationRule å­¦æ ¡æ•°æ®å˜æ›´è§„åˆ™
func SchoolMutationRule() privacy.MutationRule {
	return privacy.MutationRuleFunc(func(ctx context.Context, m ent.Mutation) error {
		// ä» Context è·å– school_id
		schoolID, ok := ctx.Value("school_id").(uuid.UUID)
		if !ok {
			return privacy.Denyf("missing school_id in context")
		}

		// åˆ›å»ºæ“ä½œï¼šè‡ªåŠ¨è®¾ç½® school_id
		if m.Op().Is(ent.OpCreate) {
			if err := m.SetField("school_id", schoolID); err != nil {
				return err
			}
		}

		// æ›´æ–°/åˆ é™¤æ“ä½œï¼šéªŒè¯ school_id
		if m.Op().Is(ent.OpUpdate | ent.OpUpdateOne | ent.OpDelete | ent.OpDeleteOne) {
			// ç¡®ä¿åªèƒ½æ“ä½œæœ¬æ ¡çš„æ•°æ®
			// è¿™é‡Œéœ€è¦åœ¨ Query å±‚é¢é™åˆ¶ï¼Œå…·ä½“å®ç°å–å†³äºä¸šåŠ¡
		}

		return privacy.Skip
	})
}
```

### 3.3 Casbin æƒé™å¼•æ“ç¤ºä¾‹

#### 3.3.1 Casbin Ent Adapterï¼ˆåªè¯»æ¨¡å¼ï¼‰

**è®¾è®¡è¯´æ˜**ï¼šAdapter é‡‡ç”¨åªè¯»æ¨¡å¼ï¼Œä»…æ”¯æŒä»æ•°æ®åº“åŠ è½½ç­–ç•¥ã€‚ç­–ç•¥å˜æ›´é€šè¿‡ Ent API ç›´æ¥ä¿®æ”¹æ•°æ®åº“ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`core/casbin/ent_adapter.go`

```go
package casbin

import (
	"context"
	"fmt"
	"time"

	"github.com/casbin/casbin/v2/model"
	"github.com/casbin/casbin/v2/persist"
	"github.com/google/uuid"
	"your-project/data/ent"
	"your-project/data/ent/role"
	"your-project/data/ent/userrole"
)

// EntAdapter Ent é€‚é…å™¨ï¼ˆåªè¯»æ¨¡å¼ï¼‰
type EntAdapter struct {
	client *ent.Client
}

// NewEntAdapter åˆ›å»º Ent é€‚é…å™¨
func NewEntAdapter(client *ent.Client) *EntAdapter {
	return &EntAdapter{client: client}
}

// LoadPolicy ä»æ•°æ®åº“åŠ è½½ç­–ç•¥
func (a *EntAdapter) LoadPolicy(model model.Model) error {
	ctx := context.Background()

	// 1. åŠ è½½è§’è‰²-æƒé™å…³ç³»ï¼ˆp ç­–ç•¥ï¼‰
	roles, err := a.client.Role.Query().
		Where(role.IsActiveEQ(true)).
		WithPermissions().
		All(ctx)
	if err != nil {
		return err
	}

	for _, r := range roles {
		for _, perm := range r.Edges.Permissions {
			// p, role_id, resource, action, school_id
			// é›†å›¢è§’è‰²ä½¿ç”¨ "global"ï¼Œå­¦æ ¡è§’è‰²ä½¿ç”¨ school_id
			schoolStr := "global"
			if r.SchoolID != uuid.Nil {
				schoolStr = r.SchoolID.String()
			}

			line := fmt.Sprintf("p, %s, %s, %s, %s",
				r.ID.String(),
				perm.Resource,
				perm.Action,
				schoolStr,
			)
			persist.LoadPolicyLine(line, model)
		}
	}

	// 2. åŠ è½½ç”¨æˆ·-è§’è‰²å…³ç³»ï¼ˆg ç­–ç•¥ï¼‰ï¼Œè¿‡æ»¤æ—¶é—´èŒƒå›´
	now := time.Now()
	userRoles, err := a.client.UserRole.Query().
		Where(
			// æ£€æŸ¥ effective_fromï¼šä¸ºç©ºæˆ–å°äºç­‰äºå½“å‰æ—¶é—´
			userrole.Or(
				userrole.EffectiveFromIsNil(),
				userrole.EffectiveFromLTE(now),
			),
			// æ£€æŸ¥ effective_toï¼šä¸ºç©ºæˆ–å¤§äºå½“å‰æ—¶é—´
			userrole.Or(
				userrole.EffectiveToIsNil(),
				userrole.EffectiveToGT(now),
			),
		).
		All(ctx)
	if err != nil {
		return err
	}

	for _, ur := range userRoles {
		// g, user_id, role_id, school_id
		schoolStr := "global"
		if ur.SchoolID != uuid.Nil {
			schoolStr = ur.SchoolID.String()
		}

		line := fmt.Sprintf("g, %s, %s, %s",
			ur.UserID.String(),
			ur.RoleID.String(),
			schoolStr,
		)
		persist.LoadPolicyLine(line, model)
	}

	return nil
}

// SavePolicy ä¿å­˜ç­–ç•¥ï¼ˆæœªå®ç°ï¼Œåªè¯»æ¨¡å¼ï¼‰
func (a *EntAdapter) SavePolicy(model model.Model) error {
	return fmt.Errorf("SavePolicy not implemented: use Ent API to modify Role/Permission/UserRole directly")
}

// AddPolicy æ·»åŠ ç­–ç•¥ï¼ˆæœªå®ç°ï¼Œåªè¯»æ¨¡å¼ï¼‰
func (a *EntAdapter) AddPolicy(sec string, ptype string, rule []string) error {
	return fmt.Errorf("AddPolicy not implemented: use Ent API to create Role/UserRole")
}

// RemovePolicy åˆ é™¤ç­–ç•¥ï¼ˆæœªå®ç°ï¼Œåªè¯»æ¨¡å¼ï¼‰
func (a *EntAdapter) RemovePolicy(sec string, ptype string, rule []string) error {
	return fmt.Errorf("RemovePolicy not implemented: use Ent API to delete Role/UserRole")
}

// RemoveFilteredPolicy åˆ é™¤è¿‡æ»¤ç­–ç•¥ï¼ˆæœªå®ç°ï¼Œåªè¯»æ¨¡å¼ï¼‰
func (a *EntAdapter) RemoveFilteredPolicy(sec string, ptype string, fieldIndex int, fieldValues ...string) error {
	return fmt.Errorf("RemoveFilteredPolicy not implemented: use Ent Query API")
}
```

#### 3.3.2 Casbin model.conf é…ç½®

**æ–‡ä»¶è·¯å¾„**ï¼š`core/casbin/model.conf`

```ini
[request_definition]
r = sub, obj, act, school

[policy_definition]
p = sub, obj, act, school

[role_definition]
g = _, _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub, r.school) && r.obj == p.obj && r.act == p.act && r.school == p.school
```

#### 3.3.3 Casbin Enforcer åˆå§‹åŒ–

**æ–‡ä»¶è·¯å¾„**ï¼š`core/casbin/enforcer.go`

```go
package casbin

import (
	"sync"
	"time"

	"github.com/casbin/casbin/v2"
	"github.com/zeromicro/go-zero/core/logx"
	"your-project/data/ent"
)

var (
	enforcer *casbin.Enforcer
	once     sync.Once
)

// InitEnforcer åˆå§‹åŒ– Casbin Enforcerï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
func InitEnforcer(entClient *ent.Client) (*casbin.Enforcer, error) {
	var err error
	once.Do(func() {
		adapter := NewEntAdapter(entClient)
		enforcer, err = casbin.NewEnforcer("core/casbin/model.conf", adapter)
		if err != nil {
			return
		}

		// åŠ è½½ç­–ç•¥
		if err = enforcer.LoadPolicy(); err != nil {
			return
		}

		// å¯åŠ¨å®šæœŸåˆ·æ–°ç­–ç•¥ï¼ˆæ¯å°æ—¶åˆ·æ–°ä¸€æ¬¡ï¼‰
		go refreshPolicy(enforcer)

		logx.Info("Casbin enforcer initialized successfully")
	})

	return enforcer, err
}

// refreshPolicy å®šæœŸåˆ·æ–°ç­–ç•¥
func refreshPolicy(e *casbin.Enforcer) {
	ticker := time.NewTicker(1 * time.Hour)
	defer ticker.Stop()

	for range ticker.C {
		if err := e.LoadPolicy(); err != nil {
			logx.Errorf("failed to refresh casbin policy: %v", err)
		} else {
			logx.Info("Casbin policy refreshed, expired roles removed")
		}
	}
}

// GetEnforcer è·å– Enforcer å®ä¾‹
func GetEnforcer() *casbin.Enforcer {
	return enforcer
}
```

#### 3.3.4 Casbin æƒé™æ£€æŸ¥ä¸­é—´ä»¶

**æ–‡ä»¶è·¯å¾„**ï¼š`core/middleware/casbin_middleware.go`

```go
package middleware

import (
	"net/http"

	"github.com/casbin/casbin/v2"
	"github.com/google/uuid"
	"github.com/zeromicro/go-zero/core/logx"
	"github.com/zeromicro/go-zero/rest/httpx"
)

// CasbinMiddleware Casbin æƒé™æ£€æŸ¥ä¸­é—´ä»¶
func CasbinMiddleware(enforcer *casbin.Enforcer, resource, action string) func(http.HandlerFunc) http.HandlerFunc {
	return func(next http.HandlerFunc) http.HandlerFunc {
		return func(w http.ResponseWriter, r *http.Request) {
			ctx := r.Context()

			// 1. è·å–ç”¨æˆ·ID
			userID, ok := ctx.Value("user_id").(string)
			if !ok {
				httpx.Error(w, &httpx.CodeError{
					Code: http.StatusUnauthorized,
					Msg:  "missing user context",
				})
				return
			}

			// 2. è·å– school_id
			schoolID, ok := ctx.Value("school_id").(uuid.UUID)
			if !ok {
				httpx.Error(w, &httpx.CodeError{
					Code: http.StatusUnauthorized,
					Msg:  "missing school context",
				})
				return
			}

			// 3. ç‰¹æ®Šå¤„ç†ï¼šé›†å›¢ç”¨æˆ·å…¨å±€æ¨¡å¼ï¼ˆschool_id ä¸º uuid.Nilï¼‰
			userType, _ := ctx.Value("user_type").(string)
			if userType == "GROUP" && schoolID == uuid.Nil {
				// é›†å›¢ç”¨æˆ·åœ¨å…¨å±€æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ "global" è¿›è¡Œæƒé™æ£€æŸ¥
				allowed, err := enforcer.Enforce(
					userID,
					resource,
					action,
					"global", // é›†å›¢å…¨å±€æƒé™æ ‡è¯†
				)

				if err != nil {
					logx.WithContext(ctx).Errorf("casbin enforce error: %v", err)
					httpx.Error(w, &httpx.CodeError{
						Code: http.StatusInternalServerError,
						Msg:  "permission check failed",
					})
					return
				}

				if !allowed {
					httpx.Error(w, &httpx.CodeError{
						Code: http.StatusForbidden,
						Msg:  "permission denied",
					})
					return
				}

				next(w, r.WithContext(ctx))
				return
			}

			// 4. å¸¸è§„æƒé™æ£€æŸ¥ï¼ˆå­¦æ ¡ç”¨æˆ·æˆ–é›†å›¢ä»£ç®¡æ¨¡å¼ï¼‰
			allowed, err := enforcer.Enforce(
				userID,
				resource,
				action,
				schoolID.String(),
			)

			if err != nil {
				logx.WithContext(ctx).Errorf("casbin enforce error: %v", err)
				httpx.Error(w, &httpx.CodeError{
					Code: http.StatusInternalServerError,
					Msg:  "permission check failed",
				})
				return
			}

			if !allowed {
				logx.WithContext(ctx).Warnf("permission denied: user=%s, resource=%s, action=%s, school=%s",
					userID, resource, action, schoolID)
				httpx.Error(w, &httpx.CodeError{
					Code: http.StatusForbidden,
					Msg:  "permission denied",
				})
				return
			}

			// 5. æƒé™æ£€æŸ¥é€šè¿‡ï¼Œç»§ç»­å¤„ç†
			next(w, r.WithContext(ctx))
		}
	}
}
```

#### 3.3.5 åœ¨ API ä¸­ä½¿ç”¨ Casbin ä¸­é—´ä»¶

**æ–‡ä»¶è·¯å¾„**ï¼š`apps/educational/api/educational.go`

```go
package main

import (
	"flag"
	"fmt"
	"net/http"

	"github.com/zeromicro/go-zero/rest"
	"your-project/apps/educational/api/internal/config"
	"your-project/apps/educational/api/internal/handler"
	"your-project/apps/educational/api/internal/svc"
	"your-project/core/casbin"
	"your-project/core/middleware"
)

var configFile = flag.String("f", "etc/educational-api.yaml", "the config file")

func main() {
	flag.Parse()

	var c config.Config
	conf.MustLoad(*configFile, &c)

	ctx := svc.NewServiceContext(c)
	server := rest.MustNewServer(c.RestConf)
	defer server.Stop()

	// åˆå§‹åŒ– Casbin Enforcer
	enforcer, err := casbin.InitEnforcer(ctx.DB)
	if err != nil {
		panic(fmt.Sprintf("failed to init casbin: %v", err))
	}

	// å…¨å±€ä¸­é—´ä»¶
	server.Use(middleware.SchoolInterceptor())

	// è·¯ç”±æ³¨å†Œï¼ˆå¸¦æƒé™æ£€æŸ¥ï¼‰
	server.AddRoutes(
		rest.WithMiddlewares(
			[]rest.Middleware{
				middleware.CasbinMiddleware(enforcer, "student", "create"),
			},
			[]rest.Route{
				{
					Method:  http.MethodPost,
					Path:    "/api/v1/students",
					Handler: handler.CreateStudentHandler(ctx),
				},
			}...,
		),
	)

	server.Start()
}
```

---

## 4. Makefile è‡ªåŠ¨åŒ–è„šæœ¬

**æ–‡ä»¶è·¯å¾„**ï¼š`Makefile`

```makefile
.PHONY: help env gen lint test build migrate clean

# é»˜è®¤ç›®æ ‡
help:
	@echo "å¯ç”¨å‘½ä»¤ï¼š"
	@echo "  make env       - å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆdocker-composeï¼‰"
	@echo "  make gen       - ç”Ÿæˆä»£ç ï¼ˆEnt + go-zeroï¼‰"
	@echo "  make lint      - è¿è¡Œä»£ç é™æ€æ£€æŸ¥"
	@echo "  make test      - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  make build     - ç¼–è¯‘æ‰€æœ‰æœåŠ¡"
	@echo "  make migrate   - æ‰§è¡Œæ•°æ®åº“è¿ç§»"
	@echo "  make clean     - æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶"

# å¯åŠ¨å¼€å‘ç¯å¢ƒ
env:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	bash scripts/dev-env.sh

# ç”Ÿæˆä»£ç 
gen:
	@echo "ğŸ“ ç”Ÿæˆ Ent ä»£ç ..."
	go generate ./data/ent

	@echo "ğŸ“ ç”Ÿæˆ go-zero API ä»£ç ..."
	goctl api go -api manifests/api/organization.api -dir apps/organization/api -style go_zero
	goctl api go -api manifests/api/auth.api -dir apps/auth/api -style go_zero
	goctl api go -api manifests/api/educational.api -dir apps/educational/api -style go_zero

	@echo "ğŸ“ ç”Ÿæˆ go-zero RPC ä»£ç ..."
	goctl rpc protoc manifests/rpc/organization.proto --go_out=apps/organization/rpc --go-grpc_out=apps/organization/rpc --zrpc_out=apps/organization/rpc

	@echo "âœ… ä»£ç ç”Ÿæˆå®Œæˆ"

# é™æ€æ£€æŸ¥
lint:
	@echo "ğŸ” è¿è¡Œé™æ€æ£€æŸ¥..."
	golangci-lint run ./...

# å•å…ƒæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	go test -v -cover -race ./...

# æµ‹è¯•è¦†ç›–ç‡
test-coverage:
	@echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	go test -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: coverage.html"

# ç¼–è¯‘æ‰€æœ‰æœåŠ¡
build:
	@echo "ğŸ”¨ ç¼–è¯‘æ‰€æœ‰æœåŠ¡..."
	go build -o bin/organization-api ./apps/organization/api
	go build -o bin/organization-rpc ./apps/organization/rpc
	go build -o bin/auth-api ./apps/auth/api
	go build -o bin/educational-api ./apps/educational/api
	@echo "âœ… ç¼–è¯‘å®Œæˆï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶åœ¨ bin/ ç›®å½•"

# æ•°æ®åº“è¿ç§»
migrate:
	@echo "ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
	go run data/migration/main.go

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶..."
	rm -rf bin/
	rm -f coverage.out coverage.html
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ’… æ ¼å¼åŒ–ä»£ç ..."
	go fmt ./...
	goimports -w .

# å®‰è£…ä¾èµ–
deps:
	@echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
	go mod download
	go mod tidy

# è¿è¡Œæ‰€æœ‰æ£€æŸ¥ï¼ˆCI ä½¿ç”¨ï¼‰
ci: lint test
	@echo "âœ… CI æ£€æŸ¥é€šè¿‡"
```

---

## 5. API å®šä¹‰ç¤ºä¾‹

### 5.1 å­¦ç”Ÿç®¡ç† API

**æ–‡ä»¶è·¯å¾„**ï¼š`manifests/api/student.api`

```go
syntax = "v1"

info(
	title: "å­¦ç”Ÿç®¡ç† API"
	desc: "å­¦ç”Ÿä¿¡æ¯çš„å¢åˆ æ”¹æŸ¥"
	author: "EduSystem Team"
	version: "v1.0"
)

// ========== ç±»å‹å®šä¹‰ ==========

type StudentInfo {
	Id         string `json:"id"`
	StudentNo  string `json:"student_no"`
	Name       string `json:"name"`
	Gender     string `json:"gender"`
	BirthDate  string `json:"birth_date,optional"`
	Phone      string `json:"phone,optional"`
	ClassName  string `json:"class_name,optional"`
	Status     string `json:"status"`
	CreatedAt  string `json:"created_at"`
}

type StudentListRequest {
	Page      int    `form:"page,default=1"`
	PageSize  int    `form:"page_size,default=20"`
	Keyword   string `form:"keyword,optional"`
	ClassId   string `form:"class_id,optional"`
	Status    string `form:"status,optional"`
}

type StudentListResponse {
	Total int64         `json:"total"`
	List  []StudentInfo `json:"list"`
}

type StudentDetailRequest {
	Id string `path:"id"`
}

type StudentDetailResponse {
	StudentInfo
}

type StudentCreateRequest {
	StudentNo string `json:"student_no"`
	Name      string `json:"name"`
	Gender    string `json:"gender"`
	BirthDate string `json:"birth_date,optional"`
	IdCard    string `json:"id_card,optional"`
	Phone     string `json:"phone,optional"`
	ClassId   string `json:"class_id,optional"`
}

type StudentCreateResponse {
	Id string `json:"id"`
}

type StudentUpdateRequest {
	Id        string `path:"id"`
	Name      string `json:"name,optional"`
	Gender    string `json:"gender,optional"`
	BirthDate string `json:"birth_date,optional"`
	Phone     string `json:"phone,optional"`
	ClassId   string `json:"class_id,optional"`
	Status    string `json:"status,optional"`
}

type StudentUpdateResponse {
	Success bool `json:"success"`
}

type StudentDeleteRequest {
	Id string `path:"id"`
}

type StudentDeleteResponse {
	Success bool `json:"success"`
}

// ========== API å®šä¹‰ ==========

@server(
	jwt: Auth
	middleware: SchoolInterceptor
	group: student
	prefix: /api/v1
)
service educational-api {
	@doc "å­¦ç”Ÿåˆ—è¡¨æŸ¥è¯¢"
	@handler StudentList
	get /students (StudentListRequest) returns (StudentListResponse)

	@doc "å­¦ç”Ÿè¯¦æƒ…"
	@handler StudentDetail
	get /students/:id (StudentDetailRequest) returns (StudentDetailResponse)

	@doc "åˆ›å»ºå­¦ç”Ÿ"
	@handler StudentCreate
	post /students (StudentCreateRequest) returns (StudentCreateResponse)

	@doc "æ›´æ–°å­¦ç”Ÿ"
	@handler StudentUpdate
	put /students/:id (StudentUpdateRequest) returns (StudentUpdateResponse)

	@doc "åˆ é™¤å­¦ç”Ÿ"
	@handler StudentDelete
	delete /students/:id (StudentDeleteRequest) returns (StudentDeleteResponse)
}
```

### 5.2 ABAC ä¸šåŠ¡å±‚æ ¡éªŒç¤ºä¾‹

**è®¾è®¡åŸåˆ™**ï¼šä¸ä½¿ç”¨ Casbin ABAC çš„ eval() å‡½æ•°ï¼Œè€Œæ˜¯åœ¨ä¸šåŠ¡å±‚è¿›è¡Œä½œç”¨åŸŸæ ¡éªŒã€‚

#### 5.2.1 ä½œç”¨åŸŸæƒé™æ£€æŸ¥å…¬å…±å‡½æ•°

**æ–‡ä»¶è·¯å¾„**ï¼š`core/permission/scope.go`

```go
package permission

import (
	"context"
	"errors"

	"github.com/google/uuid"
	"your-project/data/ent"
	"your-project/data/ent/student"
	"your-project/data/ent/userrole"
)

// CheckScopePermission æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®æŒ‡å®šå­¦ç”Ÿ
// è¿”å›ï¼š(æ˜¯å¦æœ‰æƒé™, é”™è¯¯)
func CheckScopePermission(ctx context.Context, client *ent.Client, userID string, studentID uuid.UUID) (bool, error) {
	// 1. æŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²ä½œç”¨åŸŸ
	userRoles, err := client.UserRole.Query().
		Where(userrole.UserIDEQ(uuid.MustParse(userID))).
		All(ctx)
	if err != nil {
		return false, err
	}

	if len(userRoles) == 0 {
		return false, errors.New("user has no roles assigned")
	}

	// 2. æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€æƒé™ï¼ˆscope_org_id ä¸º nilï¼‰
	hasGlobalRole := false
	scopeOrgIDs := make([]uuid.UUID, 0)

	for _, ur := range userRoles {
		if ur.ScopeOrgID == nil {
			hasGlobalRole = true
			break
		}
		scopeOrgIDs = append(scopeOrgIDs, *ur.ScopeOrgID)
	}

	// 3. å¦‚æœæœ‰å…¨å±€æƒé™ï¼ˆå¦‚æ ¡é•¿ï¼‰ï¼Œç›´æ¥é€šè¿‡
	if hasGlobalRole {
		return true, nil
	}

	// 4. æŸ¥è¯¢å­¦ç”Ÿæ‰€å±çš„ç»„ç»‡ï¼ˆç­çº§ï¼‰
	stu, err := client.Student.Query().
		Where(student.IDEQ(studentID)).
		WithClass(). // å…³è”æŸ¥è¯¢ç­çº§
		Only(ctx)
	if err != nil {
		return false, err
	}

	// 5. æ£€æŸ¥å­¦ç”Ÿçš„ç­çº§æ˜¯å¦åœ¨ç”¨æˆ·çš„ä½œç”¨åŸŸèŒƒå›´å†…
	if stu.Edges.Class != nil {
		studentClassID := stu.Edges.Class.ID
		for _, scopeID := range scopeOrgIDs {
			if studentClassID == scopeID {
				return true, nil
			}
		}
	}

	return false, nil
}

// CheckBatchScopePermission æ‰¹é‡æ£€æŸ¥ä½œç”¨åŸŸæƒé™
func CheckBatchScopePermission(ctx context.Context, client *ent.Client, userID string, studentIDs []uuid.UUID) ([]uuid.UUID, error) {
	// 1. æŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²ä½œç”¨åŸŸ
	userRoles, err := client.UserRole.Query().
		Where(userrole.UserIDEQ(uuid.MustParse(userID))).
		All(ctx)
	if err != nil {
		return nil, err
	}

	// 2. æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€æƒé™
	hasGlobalRole := false
	scopeOrgIDs := make([]uuid.UUID, 0)

	for _, ur := range userRoles {
		if ur.ScopeOrgID == nil {
			hasGlobalRole = true
			break
		}
		scopeOrgIDs = append(scopeOrgIDs, *ur.ScopeOrgID)
	}

	// 3. å¦‚æœæœ‰å…¨å±€æƒé™ï¼Œè¿”å›æ‰€æœ‰ID
	if hasGlobalRole {
		return studentIDs, nil
	}

	// 4. æŸ¥è¯¢æ‰€æœ‰å­¦ç”Ÿï¼Œå¹¶è¿‡æ»¤å‡ºæœ‰æƒé™çš„
	students, err := client.Student.Query().
		Where(student.IDIn(studentIDs...)).
		WithClass().
		All(ctx)
	if err != nil {
		return nil, err
	}

	allowedIDs := make([]uuid.UUID, 0)
	for _, stu := range students {
		if stu.Edges.Class != nil {
			classID := stu.Edges.Class.ID
			for _, scopeID := range scopeOrgIDs {
				if classID == scopeID {
					allowedIDs = append(allowedIDs, stu.ID)
					break
				}
			}
		}
	}

	return allowedIDs, nil
}
```

#### 5.2.2 Logic å±‚ä½¿ç”¨ä½œç”¨åŸŸæ ¡éªŒ

**æ–‡ä»¶è·¯å¾„**ï¼š`apps/educational/api/internal/logic/student/updatestudentlogic.go`

```go
package student

import (
	"context"
	"errors"
	"time"

	"github.com/google/uuid"
	"github.com/zeromicro/go-zero/core/logx"
	"your-project/apps/educational/api/internal/svc"
	"your-project/apps/educational/api/internal/types"
	"your-project/core/ctxdata"
	"your-project/core/permission"
	"your-project/data/ent/student"
)

type UpdateStudentLogic struct {
	logx.Logger
	ctx    context.Context
	svcCtx *svc.ServiceContext
}

func NewUpdateStudentLogic(ctx context.Context, svcCtx *svc.ServiceContext) *UpdateStudentLogic {
	return &UpdateStudentLogic{
		Logger: logx.WithContext(ctx),
		ctx:    ctx,
		svcCtx: svcCtx,
	}
}

func (l *UpdateStudentLogic) UpdateStudent(req *types.StudentUpdateRequest) (*types.StudentUpdateResponse, error) {
	userID := ctxdata.GetUserID(l.ctx)
	schoolID := ctxdata.GetSchoolID(l.ctx)

	// è§£æå­¦ç”ŸID
	studentID, err := uuid.Parse(req.Id)
	if err != nil {
		return nil, errors.New("invalid student id")
	}

	// ç¬¬ä¸€æ­¥ï¼šCasbin æ£€æŸ¥åŸºç¡€æƒé™ï¼ˆæ˜¯å¦æœ‰ student:update æƒé™ï¼‰
	allowed, err := l.svcCtx.Enforcer.Enforce(
		userID,
		"student",
		"update",
		schoolID.String(),
	)
	if err != nil {
		logx.WithContext(l.ctx).Errorf("casbin enforce error: %v", err)
		return nil, errors.New("permission check failed")
	}
	if !allowed {
		return nil, errors.New("permission denied: no student:update permission")
	}

	// ç¬¬äºŒæ­¥ï¼šä¸šåŠ¡å±‚æ£€æŸ¥ä½œç”¨åŸŸï¼ˆæ˜¯å¦æœ‰æƒé™æ“ä½œè¿™ä¸ªå…·ä½“çš„å­¦ç”Ÿï¼‰
	hasScope, err := permission.CheckScopePermission(l.ctx, l.svcCtx.DB, userID, studentID)
	if err != nil {
		logx.WithContext(l.ctx).Errorf("check scope permission error: %v", err)
		return nil, errors.New("scope check failed")
	}
	if !hasScope {
		logx.WithContext(l.ctx).Warnf("scope permission denied: user=%s, student=%s", userID, studentID)
		return nil, errors.New("permission denied: student not in your scope")
	}

	// ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæ›´æ–°æ“ä½œ
	update := l.svcCtx.DB.Student.UpdateOneID(studentID)

	if req.Name != "" {
		update.SetName(req.Name)
	}
	if req.Gender != "" {
		update.SetGender(student.Gender(req.Gender))
	}
	if req.Phone != "" {
		update.SetPhone(req.Phone)
	}
	if req.ClassId != "" {
		classID, _ := uuid.Parse(req.ClassId)
		update.SetClassID(classID)
	}
	if req.Status != "" {
		update.SetStatus(student.Status(req.Status))
	}

	err = update.Exec(l.ctx)
	if err != nil {
		logx.WithContext(l.ctx).Errorf("update student error: %v", err)
		return nil, errors.New("update failed")
	}

	logx.WithContext(l.ctx).Infof("student updated: id=%s, user=%s", studentID, userID)

	return &types.StudentUpdateResponse{
		Success: true,
	}, nil
}
```

#### 5.2.3 æ‰¹é‡æ“ä½œçš„ä½œç”¨åŸŸæ ¡éªŒ

**æ–‡ä»¶è·¯å¾„**ï¼š`apps/educational/api/internal/logic/student/batchdeletestudentlogic.go`

```go
package student

import (
	"context"
	"errors"
	"time"

	"github.com/google/uuid"
	"github.com/zeromicro/go-zero/core/logx"
	"your-project/apps/educational/api/internal/svc"
	"your-project/apps/educational/api/internal/types"
	"your-project/core/ctxdata"
	"your-project/core/permission"
	"your-project/data/ent/student"
)

type BatchDeleteStudentLogic struct {
	logx.Logger
	ctx    context.Context
	svcCtx *svc.ServiceContext
}

func NewBatchDeleteStudentLogic(ctx context.Context, svcCtx *svc.ServiceContext) *BatchDeleteStudentLogic {
	return &BatchDeleteStudentLogic{
		Logger: logx.WithContext(ctx),
		ctx:    ctx,
		svcCtx: svcCtx,
	}
}

func (l *BatchDeleteStudentLogic) BatchDeleteStudent(req *types.BatchDeleteStudentRequest) (*types.BatchDeleteStudentResponse, error) {
	userID := ctxdata.GetUserID(l.ctx)
	schoolID := ctxdata.GetSchoolID(l.ctx)

	// è§£æå­¦ç”ŸIDåˆ—è¡¨
	studentIDs := make([]uuid.UUID, 0, len(req.Ids))
	for _, idStr := range req.Ids {
		id, err := uuid.Parse(idStr)
		if err != nil {
			return nil, errors.New("invalid student id: " + idStr)
		}
		studentIDs = append(studentIDs, id)
	}

	// ç¬¬ä¸€æ­¥ï¼šCasbin æ£€æŸ¥åŸºç¡€æƒé™
	allowed, err := l.svcCtx.Enforcer.Enforce(
		userID,
		"student",
		"delete",
		schoolID.String(),
	)
	if !allowed || err != nil {
		return nil, errors.New("permission denied")
	}

	// ç¬¬äºŒæ­¥ï¼šæ‰¹é‡æ£€æŸ¥ä½œç”¨åŸŸæƒé™
	allowedIDs, err := permission.CheckBatchScopePermission(l.ctx, l.svcCtx.DB, userID, studentIDs)
	if err != nil {
		logx.WithContext(l.ctx).Errorf("check batch scope permission error: %v", err)
		return nil, errors.New("scope check failed")
	}

	if len(allowedIDs) == 0 {
		return nil, errors.New("no students in your scope")
	}

	// ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæ‰¹é‡åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
	deletedCount, err := l.svcCtx.DB.Student.Update().
		Where(student.IDIn(allowedIDs...)).
		SetDeletedAt(time.Now()).
		Save(l.ctx)
	if err != nil {
		logx.WithContext(l.ctx).Errorf("batch delete students error: %v", err)
		return nil, errors.New("delete failed")
	}

	logx.WithContext(l.ctx).Infof("batch delete students: count=%d, user=%s", deletedCount, userID)

	return &types.BatchDeleteStudentResponse{
		Success:      true,
		DeletedCount: deletedCount,
	}, nil
}
```

---

## 6. å•å…ƒæµ‹è¯•ç¤ºä¾‹

### 6.1 Logic å±‚æµ‹è¯•

**æ–‡ä»¶è·¯å¾„**ï¼š`apps/educational/api/internal/logic/student/studentlistlogic_test.go`

```go
package student

import (
	"context"
	"testing"

	"github.com/google/uuid"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"
)

// MockEntClient æ¨¡æ‹Ÿ Ent å®¢æˆ·ç«¯
type MockEntClient struct {
	mock.Mock
}

func TestStudentListLogic_StudentList(t *testing.T) {
	// å‡†å¤‡æµ‹è¯•æ•°æ®
	schoolID := uuid.New()
	ctx := context.WithValue(context.Background(), "school_id", schoolID)

	// æµ‹è¯•ç”¨ä¾‹
	tests := []struct {
		name    string
		req     *types.StudentListRequest
		wantErr bool
	}{
		{
			name: "æ­£å¸¸æŸ¥è¯¢",
			req: &types.StudentListRequest{
				Page:     1,
				PageSize: 20,
			},
			wantErr: false,
		},
		{
			name: "å¸¦å…³é”®è¯æŸ¥è¯¢",
			req: &types.StudentListRequest{
				Page:     1,
				PageSize: 20,
				Keyword:  "å¼ ä¸‰",
			},
			wantErr: false,
		},
		{
			name: "åˆ†é¡µå‚æ•°å¼‚å¸¸",
			req: &types.StudentListRequest{
				Page:     0,
				PageSize: 0,
			},
			wantErr: true,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			// TODO: å®ç°å…·ä½“æµ‹è¯•é€»è¾‘
			// 1. å‡†å¤‡ mock æ•°æ®
			// 2. è°ƒç”¨ StudentList æ–¹æ³•
			// 3. æ–­è¨€ç»“æœ
		})
	}
}

func TestStudentListLogic_SchoolDataAccess(t *testing.T) {
	// æµ‹è¯•å­¦æ ¡æ•°æ®è®¿é—®
	schoolA := uuid.New()
	schoolB := uuid.New()

	t.Run("å­¦æ ¡Aåªèƒ½æŸ¥çœ‹å­¦æ ¡Açš„æ•°æ®", func(t *testing.T) {
		ctx := context.WithValue(context.Background(), "school_id", schoolA)

		// TODO: å®ç°å­¦æ ¡æ•°æ®è®¿é—®æµ‹è¯•
		// éªŒè¯æŸ¥è¯¢ç»“æœä¸­çš„æ‰€æœ‰æ•°æ®éƒ½å±äº schoolA
	})

	t.Run("å­¦æ ¡Båªèƒ½æŸ¥çœ‹å­¦æ ¡Bçš„æ•°æ®", func(t *testing.T) {
		ctx := context.WithValue(context.Background(), "school_id", schoolB)

		// TODO: å®ç°å­¦æ ¡æ•°æ®è®¿é—®æµ‹è¯•
		// éªŒè¯æŸ¥è¯¢ç»“æœä¸­çš„æ‰€æœ‰æ•°æ®éƒ½å±äº schoolB
	})
}
```

---

## 7. CI/CD é…ç½®ç¤ºä¾‹

### 7.1 GitLab CI é…ç½®

**æ–‡ä»¶è·¯å¾„**ï¼š`.gitlab-ci.yml`

```yaml
stages:
  - lint
  - test
  - build
  - deploy

variables:
  GO_VERSION: "1.20"

# ä»£ç æ£€æŸ¥
lint:
  stage: lint
  image: golangci/golangci-lint:v1.54
  script:
    - golangci-lint run ./...
  only:
    - merge_requests
    - main
    - develop

# å•å…ƒæµ‹è¯•
test:
  stage: test
  image: golang:${GO_VERSION}
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: edu_system_test
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
  before_script:
    - go mod download
  script:
    - go test -v -cover -race ./...
    - go test -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  coverage: '/total:.*\s(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  only:
    - merge_requests
    - main
    - develop

# ç¼–è¯‘
build:
  stage: build
  image: golang:${GO_VERSION}
  before_script:
    - go mod download
  script:
    - make build
  artifacts:
    paths:
      - bin/
    expire_in: 1 week
  only:
    - main
    - develop

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
deploy_test:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config use-context test-cluster
    - kubectl apply -f deploy/k8s/test/
    - kubectl rollout status deployment/educational-api -n edu-system-test
  only:
    - develop
  when: manual

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
deploy_prod:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config use-context prod-cluster
    - kubectl apply -f deploy/k8s/prod/
    - kubectl rollout status deployment/educational-api -n edu-system-prod
  only:
    - main
  when: manual
```

---

## 8. æœ€ä½³å®è·µæ€»ç»“

### 8.1 å¼€å‘æµç¨‹

1. **æ‹‰å–æœ€æ–°ä»£ç **ï¼š`git pull origin develop`
2. **åˆ›å»ºåŠŸèƒ½åˆ†æ”¯**ï¼š`git checkout -b feature/yourname-åŠŸèƒ½å`
3. **å¯åŠ¨å¼€å‘ç¯å¢ƒ**ï¼š`make env`
4. **ä¿®æ”¹ API å®šä¹‰**ï¼šç¼–è¾‘ `.api` æ–‡ä»¶
5. **ç”Ÿæˆä»£ç **ï¼š`make gen`
6. **ç¼–å†™ä¸šåŠ¡é€»è¾‘**ï¼šåœ¨ `logic` å±‚å®ç°
7. **ç¼–å†™å•å…ƒæµ‹è¯•**ï¼šæµ‹è¯•è¦†ç›–ç‡ â‰¥80%
8. **æœ¬åœ°æµ‹è¯•**ï¼š`make test`
9. **ä»£ç æ£€æŸ¥**ï¼š`make lint`
10. **æäº¤ä»£ç **ï¼šéµå¾ª Conventional Commits è§„èŒƒ
11. **æ¨é€åˆ†æ”¯**ï¼š`git push origin feature/yourname-åŠŸèƒ½å`
12. **åˆ›å»º MR**ï¼šç­‰å¾… Code Review

### 8.2 å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| `missing school_id in context` | ä¸­é—´ä»¶æœªæ­£ç¡®æ³¨å…¥å­¦æ ¡ID | æ£€æŸ¥ä¸­é—´ä»¶é…ç½®ï¼Œç¡®ä¿ JWT åŒ…å« org_id |
| `invalid UUID format` | UUID æ ¼å¼é”™è¯¯ | ä½¿ç”¨ `uuid.Parse()` éªŒè¯ |
| Ent æŸ¥è¯¢ç»“æœä¸ºç©º | Privacy Policy è¿‡æ»¤äº†æ•°æ® | æ£€æŸ¥ Context ä¸­çš„ school_id æ˜¯å¦æ­£ç¡® |
| æ•°æ®åº“è¿æ¥å¤±è´¥ | ç¯å¢ƒæœªå¯åŠ¨ | è¿è¡Œ `make env` å¯åŠ¨å¼€å‘ç¯å¢ƒ |
| golangci-lint å¤±è´¥ | ä»£ç ä¸ç¬¦åˆè§„èŒƒ | è¿è¡Œ `make fmt` æ ¼å¼åŒ–ä»£ç  |

### 8.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 8.3.1 æ€§èƒ½æ ‡å‡†

**ç®€å•æŸ¥è¯¢æ¥å£**ï¼ˆå•è¡¨æŸ¥è¯¢ï¼Œæ— å¤æ‚è®¡ç®—ï¼‰ï¼š
- è¯¦æƒ…æŸ¥è¯¢æ¥å£ï¼šâ‰¤ 100msï¼ˆP95ï¼‰
- ç®€å•åˆ—è¡¨æŸ¥è¯¢ï¼ˆå¦‚ï¼šå­¦ç”Ÿåˆ—è¡¨ã€æ•™å¸ˆåˆ—è¡¨ï¼‰ï¼šâ‰¤ 200msï¼ˆP95ï¼‰
- æ•°æ®å†™å…¥æ¥å£ï¼ˆå•è¡¨ CRUDï¼‰ï¼šâ‰¤ 300msï¼ˆP95ï¼‰

**å¤æ‚æŸ¥è¯¢æ¥å£**ï¼ˆå¤šè¡¨å…³è”ã€èšåˆç»Ÿè®¡ã€æŠ¥è¡¨ç”Ÿæˆï¼‰ï¼š
- ç»Ÿè®¡æŠ¥è¡¨æ¥å£ï¼ˆå¦‚ï¼šå­¦æœŸæˆç»©æ±‡æ€»ï¼‰ï¼šâ‰¤ 1000msï¼ˆP95ï¼‰
- å¤æ‚åˆ—è¡¨æŸ¥è¯¢ï¼ˆå¤šè¡¨ JOINã€å­æŸ¥è¯¢ï¼‰ï¼šâ‰¤ 500msï¼ˆP95ï¼‰
- æ‰¹é‡å¯¼å…¥/å¯¼å‡ºæ¥å£ï¼šâ‰¤ 2000msï¼ˆP95ï¼‰æˆ–é‡‡ç”¨å¼‚æ­¥å¤„ç†

#### 8.3.2 ä¼˜åŒ–ç­–ç•¥

**1. ä½¿ç”¨å¤åˆç´¢å¼•**ï¼š
```go
// å°† school_id æ”¾åœ¨ç´¢å¼•é¦–ä½
func (Student) Indexes() []ent.Index {
	return []ent.Index{
		// å¤åˆç´¢å¼•ï¼šschool_id + student_no
		index.Fields("school_id", "student_no").Unique(),

		// å¤åˆç´¢å¼•ï¼šschool_id + class_idï¼ˆåŠ é€Ÿç­çº§æŸ¥è¯¢ï¼‰
		index.Fields("school_id", "class_id"),

		// å¤åˆç´¢å¼•ï¼šschool_id + statusï¼ˆåŠ é€ŸçŠ¶æ€è¿‡æ»¤ï¼‰
		index.Fields("school_id", "status"),
	}
}
```

**2. é¿å… N+1 æŸ¥è¯¢ - ä½¿ç”¨ Eager Loading**ï¼š
```go
// âŒ é”™è¯¯ï¼šN+1 æŸ¥è¯¢
students, _ := client.Student.Query().All(ctx)
for _, stu := range students {
	class, _ := stu.QueryClass().Only(ctx) // æ¯æ¬¡å¾ªç¯æŸ¥è¯¢ä¸€æ¬¡
	fmt.Println(class.Name)
}

// âœ… æ­£ç¡®ï¼šé¢„åŠ è½½å…³è”æ•°æ®
students, _ := client.Student.Query().
	WithClass(). // ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ç­çº§æ•°æ®
	All(ctx)
for _, stu := range students {
	if stu.Edges.Class != nil {
		fmt.Println(stu.Edges.Class.Name)
	}
}
```

**3. ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®**ï¼š
```go
// ç¼“å­˜ç»„ç»‡æ¶æ„æ ‘ï¼ˆå±‚çº§æ•°æ®å˜åŒ–é¢‘ç‡ä½ï¼‰
func (l *OrgTreeLogic) GetOrgTree() (*types.OrgTreeResponse, error) {
	cacheKey := fmt.Sprintf("org:tree:%s", schoolID)

	// 1. å°è¯•ä»ç¼“å­˜è·å–
	cached, err := l.svcCtx.Redis.Get(cacheKey)
	if err == nil && cached != "" {
		var tree types.OrgTreeResponse
		json.Unmarshal([]byte(cached), &tree)
		return &tree, nil
	}

	// 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
	tree := buildOrgTree(l.ctx, l.svcCtx.DB, schoolID)

	// 3. å†™å…¥ç¼“å­˜ï¼ˆTTL 30åˆ†é’Ÿï¼‰
	data, _ := json.Marshal(tree)
	l.svcCtx.Redis.Setex(cacheKey, string(data), 1800)

	return tree, nil
}
```

**4. åˆ†é¡µæŸ¥è¯¢ - é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®**ï¼š
```go
// åˆ—è¡¨æŸ¥è¯¢å¿…é¡»åˆ†é¡µ
func (l *StudentListLogic) StudentList(req *types.StudentListRequest) (*types.StudentListResponse, error) {
	// é™åˆ¶æ¯é¡µæœ€å¤§æ•°é‡
	if req.PageSize > 100 {
		req.PageSize = 100
	}

	query := l.svcCtx.DB.Student.Query()

	// è®¡ç®—æ€»æ•°
	total, _ := query.Count(l.ctx)

	// åˆ†é¡µæŸ¥è¯¢
	students, _ := query.
		Limit(req.PageSize).
		Offset((req.Page - 1) * req.PageSize).
		All(l.ctx)

	return &types.StudentListResponse{
		Total: total,
		List:  students,
	}, nil
}
```

**5. å¼‚æ­¥å¤„ç†è€—æ—¶ä»»åŠ¡ - ä½¿ç”¨ Asynq**ï¼š
```go
// æ‰¹é‡å¯¼å…¥å­¦ç”Ÿï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
func (l *ImportStudentLogic) ImportStudent(req *types.ImportStudentRequest) (*types.ImportStudentResponse, error) {
	// åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
	task := asynq.NewTask("student:import", map[string]interface{}{
		"file_url":  req.FileURL,
		"school_id": schoolID,
		"user_id":   userID,
	})

	// æäº¤åˆ°é˜Ÿåˆ—
	info, err := l.svcCtx.AsynqClient.Enqueue(task)
	if err != nil {
		return nil, errors.New("failed to enqueue task")
	}

	return &types.ImportStudentResponse{
		TaskID: info.ID,
		Status: "pending",
	}, nil
}
```

**6. ä½¿ç”¨ Jaeger é“¾è·¯è¿½è¸ªå®šä½æ…¢æŸ¥è¯¢**ï¼š
```go
// åœ¨ Logic ä¸­æ·»åŠ  Span
func (l *StudentListLogic) StudentList(req *types.StudentListRequest) (*types.StudentListResponse, error) {
	span := trace.SpanFromContext(l.ctx)
	span.SetName("StudentList")

	// æ•°æ®åº“æŸ¥è¯¢
	span.AddEvent("query_database_start")
	students, err := l.svcCtx.DB.Student.Query().All(l.ctx)
	span.AddEvent("query_database_end")

	if err != nil {
		span.SetStatus(codes.Error, err.Error())
		return nil, err
	}

	return &types.StudentListResponse{
		List: students,
	}, nil
}
```

**7. æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–**ï¼š
```yaml
# etc/config.yaml
DB:
  DataSource: postgres://...
  MaxIdleConns: 10      # æœ€å¤§ç©ºé—²è¿æ¥æ•°
  MaxOpenConns: 100     # æœ€å¤§æ‰“å¼€è¿æ¥æ•°
  ConnMaxLifetime: 3600 # è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰
```

---

## 9. é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ

### 9.1 å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨å¼€å‘ç¯å¢ƒ
make env

# ç”Ÿæˆä»£ç 
make gen

# è¿è¡Œæµ‹è¯•
make test

# ä»£ç æ£€æŸ¥
make lint

# ç¼–è¯‘
make build

# æŸ¥çœ‹ Jaeger è¿½è¸ª
open http://localhost:16686

# æŸ¥çœ‹ Kafka UI
open http://localhost:8080

# è¿æ¥æ•°æ®åº“
psql -h localhost -U edu_user -d edu_system
```

### 9.2 ç›®å½•ç»“æ„é€ŸæŸ¥

```
/edu-system
â”œâ”€â”€ apps/           # å¾®æœåŠ¡ä»£ç 
â”œâ”€â”€ core/           # å…¬å…±åº“
â”œâ”€â”€ data/           # æ•°æ®å±‚ï¼ˆEntï¼‰
â”œâ”€â”€ manifests/      # API/RPC å®šä¹‰
â”œâ”€â”€ deploy/         # éƒ¨ç½²é…ç½®
â”œâ”€â”€ scripts/        # è„šæœ¬å·¥å…·
â””â”€â”€ Makefile        # è‡ªåŠ¨åŒ–è„šæœ¬
```

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šæœ¬æ–‡æ¡£éšé¡¹ç›®è¿­ä»£æŒç»­æ›´æ–°ï¼Œæœ€åæ›´æ–°æ—¶é—´ï¼š2025-12-27 Enkh
